{% extends "base/layout.html" %}

{% block title %}Gesti√≥n de Lotes de Miel - MeliAPP{% endblock %}
{% block description %}Sistema para gestionar lotes de miel en producci√≥n ap√≠cola{% endblock %}

{% block extra_head %}
<style>
    .form-container { max-width: 100%; margin: 0 auto; }
    .form-group { margin-bottom: 1.5rem; }
    .form-label { display: block; font-weight: 600; color: #374151; margin-bottom: 0.5rem; }
    .form-input { width: 100%; padding: 0.75rem; border: 1px solid #d1d5db; border-radius: 0.375rem; font-size: 1rem; }
    .form-input:focus { outline: none; border-color: #f59e0b; box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1); }
    .btn-primary { background-color: #f59e0b; color: white; padding: 0.75rem 1.5rem; border-radius: 0.375rem; font-weight: 600; border: none; cursor: pointer; transition: background-color 0.2s; }
    .btn-primary:hover { background-color: #d97706; }
    .btn-primary:disabled { background-color: #9ca3af; cursor: not-allowed; }
    .alert { padding: 1rem; border-radius: 0.375rem; margin-bottom: 1rem; }
    .alert-success { background-color: #d1fae5; color: #065f46; border: 1px solid #a7f3d0; }
    .alert-error { background-color: #fee2e2; color: #991b1b; border: 1px solid #fca5a5; }
    .loading { display: none; }
    
    /* Modal Styles */
    .modal-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background-color: rgba(0, 0, 0, 0.5);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 50;
        opacity: 0;
        visibility: hidden;
        transition: opacity 0.3s ease, visibility 0.3s ease;
    }
    
    .modal-overlay.active {
        opacity: 1;
        visibility: visible;
    }
    
    .modal {
        background-color: white;
        border-radius: 0.5rem;
        width: 90%;
        max-width: 500px;
        box-shadow: 0 10px 25px rgba(0, 0, 0, 0.15);
        transform: scale(0.95);
        transition: transform 0.3s ease;
        overflow: hidden;
    }
    
    .modal-overlay.active .modal {
        transform: scale(1);
    }
    
    .modal-header {
        background-color: #fee2e2;
        padding: 1rem 1.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
        border-bottom: 1px solid #fca5a5;
    }
    
    .modal-title {
        color: #991b1b;
        font-size: 1.25rem;
        font-weight: 600;
        display: flex;
        align-items: center;
        gap: 0.75rem;
    }
    
    .modal-close {
        background: none;
        border: none;
        font-size: 1.5rem;
        cursor: pointer;
        color: #991b1b;
        display: flex;
        align-items: center;
        justify-content: center;
        width: 2rem;
        height: 2rem;
        border-radius: 9999px;
        transition: background-color 0.2s;
    }
    
    .modal-close:hover {
        background-color: rgba(252, 165, 165, 0.5);
    }
    
    .modal-body {
        padding: 1.5rem;
    }
    
    .modal-footer {
        padding: 1rem 1.5rem;
        background-color: #f9fafb;
        display: flex;
        justify-content: flex-end;
        gap: 0.75rem;
        border-top: 1px solid #e5e7eb;
    }
    
    .btn-cancel {
        background-color: #e5e7eb;
        color: #4b5563;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .btn-cancel:hover {
        background-color: #d1d5db;
    }
    
    .btn-delete {
        background-color: #ef4444;
        color: white;
        padding: 0.5rem 1rem;
        border-radius: 0.375rem;
        font-weight: 500;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    
    .btn-delete:hover {
        background-color: #dc2626;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Gesti√≥n de Lotes de Miel</h1>
        <p class="text-gray-600">Registra y actualiza informaci√≥n de tus lotes de producci√≥n ap√≠cola</p>
    </div>

    <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
        <div class="lg:col-span-2">
            <div class="form-container">
        <div id="alert-container"></div>
        
        <form id="lote-form" class="bg-white shadow-lg rounded-lg p-6">
            <input type="hidden" id="usuario_id" name="usuario_id" value="{{ session['user_id'] if session.get('user_id') else '' }}">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                    <label class="form-label" for="nombre_miel">Nombre de la Miel</label>
                    <input type="text" id="nombre_miel" name="nombre_miel" class="form-input" 
                           placeholder="Ej: Miel de Ulmo Primavera" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Temporadas de Cosecha</label>
                    <div class="temporadas-container bg-gray-50 p-4 rounded-lg border">
                        <div class="space-y-3 mb-4">
                            <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                <input type="checkbox" name="temporadas" value="PRIMAVERA" class="temporada-checkbox">
                                <span class="text-sm font-medium">üå∏ Primavera</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                <input type="checkbox" name="temporadas" value="VERANO" class="temporada-checkbox">
                                <span class="text-sm font-medium">‚òÄÔ∏è Verano</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                <input type="checkbox" name="temporadas" value="OTO√ëO" class="temporada-checkbox">
                                <span class="text-sm font-medium">üçÇ Oto√±o</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                <input type="checkbox" name="temporadas" value="INVIERNO" class="temporada-checkbox">
                                <span class="text-sm font-medium">‚ùÑÔ∏è Invierno</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="anio_cosecha">A√±o de Cosecha</label>
                            <select id="anio_cosecha" name="anio_cosecha" class="form-input" required>
                                <option value="">Selecciona a√±o</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="form-group">
                    <label class="form-label" for="orden_miel">N√∫mero de Orden</label>
                    <input type="number" id="orden_miel" name="orden_miel" class="form-input" 
                           placeholder="Ej: 1" min="1" max="9999" 
                           step="1" required>
                    <small class="text-gray-500">N√∫mero √∫nico para identificar este lote</small>
                </div>
                
                <div class="form-group md:col-span-2">
                    <label class="form-label" for="kg_producidos">Kilogramos Producidos</label>
                    <input type="number" id="kg_producidos" name="kg_producidos" class="form-input" 
                           placeholder="Ej: 150.50" min="0" max="99999.99" 
                           step="0.01" pattern="^\d+(\.\d{1,2})?$" required>
                    <small class="text-gray-500">Formato: n√∫mero entero con hasta 2 decimales (ej: 150.50)</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Fecha de Registro</label>
                    <div class="date-picker-container">
                        <div class="grid grid-cols-3 gap-2">
                            <div>
                                <label class="text-xs text-gray-600">D√≠a</label>
                                <select id="dia_registro" name="dia_registro" class="form-input text-sm" required>
                                    <option value="">D√≠a</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-gray-600">Mes</label>
                                <select id="mes_registro" name="mes_registro" class="form-input text-sm" required>
                                    <option value="">Mes</option>
                                    <option value="1">Enero</option>
                                    <option value="2">Febrero</option>
                                    <option value="3">Marzo</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Mayo</option>
                                    <option value="6">Junio</option>
                                    <option value="7">Julio</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Septiembre</option>
                                    <option value="10">Octubre</option>
                                    <option value="11">Noviembre</option>
                                    <option value="12">Diciembre</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-gray-600">A√±o</label>
                                <select id="anio_registro" name="anio_registro" class="form-input text-sm" required>
                                    <option value="">A√±o</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-2">
                            <button type="button" id="fecha-hoy" class="text-sm text-blue-600 hover:text-blue-800">
                                üìÖ Usar fecha de hoy
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Composici√≥n de Polen por Zona</label>
                <div id="composicion-container" class="space-y-2">
                    <div class="flex items-center space-x-2 composicion-fila">
                        <select class="composicion-tipo form-input flex-1" id="especies-zona">
                            <option value="">Cargando especies de tu zona...</option>
                            <option value="Otras Especies">üåø Otras Especies (Origen no certificado)</option>
                        </select>
                        <input type="number" class="composicion-porcentaje form-input w-24" 
                               placeholder="%" min="0" max="100" step="1">
                        <button type="button" class="btn-remove-composicion text-red-600 hover:text-red-800">
                            ‚úï
                        </button>
                    </div>
                </div>
                <button type="button" id="add-composicion" class="text-sm text-blue-600 hover:text-blue-800">
                    + Agregar especie
                </button>
                <small class="text-gray-500" id="zona-info">Las especies se cargar√°n seg√∫n tu comuna registrada</small>
            </div>

            <div class="flex space-x-4">
                <button type="submit" class="btn-primary flex-1">
                    <span class="submit-text">Guardar Lote</span>
                    <span class="loading">Guardando...</span>
                </button>
                <button type="button" onclick="resetForm()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    Limpiar Formulario
                </button>
            </div>
        </form>

        <div id="result-container" class="mt-6" style="display: none;">
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-green-800 mb-2">‚úÖ Lote Guardado Exitosamente</h3>
                <p class="text-green-700">ID del lote: <span id="lote-id" class="font-mono"></span></p>
                <p class="text-green-700">Orden: <span id="lote-orden" class="font-mono"></span></p>
                <div class="mt-4 flex space-x-4">
                    <button onclick="resetForm()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                        Registrar otro lote
                    </button>
                    <button onclick="viewLotes()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        Ver mis lotes
                    </button>
                </div>
            </div>
        </div>

        <!-- Secci√≥n del Carrusel de Lotes -->
            </div>
        </div>

        <div class="lg:col-span-1 space-y-8">
            <div id="botanical-chart-container" class="h-full">
                 <!-- El gr√°fico bot√°nico se renderizar√° aqu√≠ -->
            </div>
        </div>
    </div>

    <div id="lotes-list" class="mt-8">
        <h2 class="text-2xl font-bold text-gray-900 mb-4">Mis Lotes de Miel Registrados</h2>
        <div class="overflow-x-auto">
            <table class="min-w-full bg-white border border-gray-200 rounded-lg" id="tabla-lotes">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Orden</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Temporada</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha Origen</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kilogramos</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Composici√≥n</th>
                        <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                    </tr>
                </thead>
                <tbody id="lotes-tbody" class="divide-y divide-gray-200">
                    <!-- Los lotes se cargar√°n din√°micamente -->
                    <tr class="hover:bg-gray-50">
                        <td class="px-4 py-4 text-center text-sm text-gray-500" colspan="7">
                            No hay lotes registrados a√∫n. Crea tu primer lote arriba.
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>
    </div>
    </div>
</div>

<!-- Modal de confirmaci√≥n para eliminar lote -->
<div id="delete-modal-overlay" class="modal-overlay">
    <div class="modal">
        <div class="modal-header">
            <h3 class="modal-title"><span>‚ö†Ô∏è</span> Confirmar eliminaci√≥n</h3>
            <button type="button" class="modal-close" id="modal-close">&times;</button>
        </div>
        <div class="modal-body">
            <p>¬øEst√°s seguro que deseas eliminar este lote de miel?</p>
            <p class="font-medium mt-2">Esta acci√≥n no se puede deshacer.</p>
            <div class="bg-gray-50 p-3 rounded-lg mt-3 border border-gray-200">
                <p class="font-medium text-sm">Lote: <span id="modal-lote-nombre" class="font-bold"></span></p>
                <p class="text-sm">Orden: #<span id="modal-lote-orden"></span></p>
            </div>
        </div>
        <div class="modal-footer">
            <button type="button" class="btn-cancel" id="btn-cancel">Cancelar</button>
            <button type="button" class="btn-delete" id="btn-confirm-delete">Eliminar Lote</button>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
// ===== GESTI√ìN DE LOTES - REFACTORIZADO =====
class LoteManager {
    constructor() {
        this.form = document.getElementById('lote-form');
        this.alertContainer = document.getElementById('alert-container');
        this.resultContainer = document.getElementById('result-container');
        this.loteIdSpan = document.getElementById('lote-id');
        this.editingLoteId = null;
        this.currentLoteData = null;
        
        this.init();
    }

    init() {
        this.initializeSelectors();
        this.bindEvents();
        this.loadSpecies();
        this.loadLotes();
    }

    // ===== UTILIDADES =====
    showAlert(message, type = 'error') {
        this.alertContainer.innerHTML = '';
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        this.alertContainer.appendChild(alert);
        
        if (type === 'success') setTimeout(() => alert.remove(), 5000);
    }

    resetForm() {
        this.form.reset();
        this.resultContainer.style.display = 'none';
        this.alertContainer.innerHTML = '';
        this.editingLoteId = null;
        this.currentLoteData = null;
        this.enableDateFields();
        document.querySelector('.submit-text').textContent = 'Guardar Lote';
    }

    // ===== VALIDACIONES =====
    getComposicionPolen() {
        const composiciones = [];
        const filas = document.querySelectorAll('.composicion-fila');
        let totalPorcentaje = 0;
        
        filas.forEach(fila => {
            const tipo = fila.querySelector('.composicion-tipo').value.trim();
            const porcentaje = parseInt(fila.querySelector('.composicion-porcentaje').value) || 0;
            
            if (tipo && porcentaje > 0) {
                const tipoLimpio = tipo.replace(/\s+/g, ' ').trim();
                composiciones.push(`${tipoLimpio}:${porcentaje}`);
                totalPorcentaje += porcentaje;
            }
        });
        
        if (totalPorcentaje > 100) {
            this.showAlert('La suma de porcentajes no puede exceder 100%', 'error');
            return null;
        }
        
        return composiciones.length === 0 ? '' : composiciones.join(', ');
    }

    getTemporadasSeleccionadas() {
        const checkboxes = document.querySelectorAll('.temporada-checkbox:checked');
        if (checkboxes.length === 0) {
            this.showAlert('Debe seleccionar al menos una temporada', 'error');
            return null;
        }
        return Array.from(checkboxes).map(cb => cb.value).join(' - ');
    }

    getFechaRegistro() {
        const dia = document.getElementById('dia_registro').value;
        const mes = document.getElementById('mes_registro').value;
        const anio = document.getElementById('anio_registro').value;
        
        if (!dia || !mes || !anio) {
            this.showAlert('Debe completar la fecha de registro', 'error');
            return null;
        }
        
        const fecha = new Date(anio, mes - 1, dia);
        if (fecha.getDate() != dia || fecha.getMonth() != mes - 1 || fecha.getFullYear() != anio) {
            this.showAlert('Fecha de registro inv√°lida', 'error');
            return null;
        }
        
        return `${anio}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
    }

    // ===== INICIALIZACI√ìN =====
    initializeSelectors() {
        const diaSelect = document.getElementById('dia_registro');
        for (let i = 1; i <= 31; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            diaSelect.appendChild(option);
        }
        
        const anioRegistroSelect = document.getElementById('anio_registro');
        const anioCosechaSelect = document.getElementById('anio_cosecha');
        const anioActual = new Date().getFullYear();
        
        for (let i = anioActual; i >= 1990; i--) {
            [anioRegistroSelect, anioCosechaSelect].forEach(select => {
                const option = document.createElement('option');
                option.value = i;
                option.textContent = i;
                select.appendChild(option);
            });
        }
    }

    bindEvents() {
        // Fecha de hoy
        document.getElementById('fecha-hoy').addEventListener('click', () => {
            const hoy = new Date();
            document.getElementById('dia_registro').value = hoy.getDate();
            document.getElementById('mes_registro').value = hoy.getMonth() + 1;
            document.getElementById('anio_registro').value = hoy.getFullYear();
        });

        // Env√≠o de formulario
        this.form.addEventListener('submit', (e) => this.handleSubmit(e));

        // Agregar composici√≥n - EVENTO √öNICO Y ROBUSTO
        document.addEventListener('click', (e) => {
            if (e.target && e.target.id === 'add-composicion') {
                e.preventDefault();
                e.stopPropagation();
                this.addComposicionRow();
            }
        });

        // Eliminar composici√≥n (delegado)
        document.addEventListener('click', (e) => {
            if (e.target.classList.contains('btn-remove-composicion')) {
                e.target.closest('.composicion-fila').remove();
            }
        });
        
        // Modal de confirmaci√≥n para eliminar
        document.getElementById('modal-close').addEventListener('click', () => this.closeModal());
        document.getElementById('btn-cancel').addEventListener('click', () => this.closeModal());
        document.getElementById('btn-confirm-delete').addEventListener('click', (e) => {
            const loteId = e.target.getAttribute('data-lote-id');
            if (loteId) this.performDelete(loteId);
        });
    }

    // ===== ESPECIES =====
    async loadSpecies() {
        try {
            const usuarioId = document.getElementById('usuario_id').value;
            if (!usuarioId) return;

            const response = await fetch(`/api/usuario-info/${usuarioId}`);
            const data = await response.json();
            
            if (data.success && data.especies?.length > 0) {
                this.updateSpeciesSelectors(data.especies);
                this.showSpeciesStatus('success', `${data.total_especies} especies disponibles para ${data.comuna}`);
            } else {
                this.showSpeciesStatus('warning', 'No hay especies para tu zona');
                this.updateSpeciesSelectors([]);
            }
        } catch (error) {
            this.showSpeciesStatus('error', 'Error al cargar especies');
            this.updateSpeciesSelectors([]);
        }
    }

    updateSpeciesSelectors(especies) {
        const selectors = document.querySelectorAll('.composicion-tipo');
        selectors.forEach(select => {
            const currentValue = select.value;
            select.innerHTML = '<option value="">Selecciona especie</option>';
            
            especies.forEach(especie => {
                const option = document.createElement('option');
                option.value = especie;
                option.textContent = especie;
                if (especie === currentValue) option.selected = true;
                select.appendChild(option);
            });
            
            // Agregar "Otras Especies"
            const otrasOption = document.createElement('option');
            otrasOption.value = 'Otras Especies';
            otrasOption.textContent = 'üåø Otras Especies (Origen no certificado)';
            if ('Otras Especies' === currentValue) otrasOption.selected = true;
            select.appendChild(otrasOption);
        });
    }

    showSpeciesStatus(type, message) {
        const zonaInfo = document.getElementById('zona-info');
        const icons = { loading: 'üîÑ', success: '‚úÖ', warning: '‚ö†Ô∏è', error: '‚ùå' };
        const classes = {
            loading: 'text-sm text-blue-600',
            success: 'text-sm text-green-600', 
            warning: 'text-sm text-yellow-600',
            error: 'text-sm text-red-600'
        };
        
        zonaInfo.textContent = `${icons[type]} ${message}`;
        zonaInfo.className = classes[type];
    }

    addComposicionRow() {
        // PROCESO √öNICO Y ROBUSTO - Sin duplicados
        const container = document.getElementById('composicion-container');
        const zonaSelect = document.getElementById('especies-zona');
        
        if (!container || !zonaSelect) {
            console.error('‚ùå Elementos no encontrados');
            return;
        }
        
        // Crear exactamente UN slot para especies
        const newRow = document.createElement('div');
        newRow.className = 'flex items-center space-x-2 composicion-fila';
        newRow.innerHTML = `
            <select class="composicion-tipo form-input flex-1">
                ${zonaSelect.innerHTML}
            </select>
            <input type="number" class="composicion-porcentaje form-input w-24" 
                   placeholder="%" min="0" max="100" step="1" value="">
            <button type="button" class="btn-remove-composicion text-red-600 hover:text-red-800">‚úï</button>
        `;
        
        // Agregar sin l√≠mite - exactamente 1 slot por click
        container.appendChild(newRow);
    }

    // ===== ENV√çO DE FORMULARIO =====
    isSubmitting = false; // Bandera para evitar env√≠os duplicados
    debounceTimeout = null; // Para implementar debounce
    
    async handleSubmit(e) {
        e.preventDefault();
        e.stopPropagation(); // Evitar propagaci√≥n del evento
        
        // Si ya est√° en proceso de env√≠o, cancelar esta solicitud
        if (this.isSubmitting) {
            console.log('Evitando env√≠o duplicado - ya est√° en proceso');
            return;
        }
        
        // Aplicar debounce para evitar m√∫ltiples clicks
        clearTimeout(this.debounceTimeout);
        this.debounceTimeout = setTimeout(async () => {
            // Marcar como en proceso de env√≠o
            this.isSubmitting = true;
            
            const submitBtn = this.form.querySelector('button[type="submit"]');
            const submitText = submitBtn.querySelector('.submit-text');
            const loadingText = submitBtn.querySelector('.loading');
            
            const composicionPolen = this.getComposicionPolen();
            if (composicionPolen === null) {
                this.isSubmitting = false;
                return;
            }
            
            const temporadas = this.getTemporadasSeleccionadas();
            if (!temporadas) {
                this.isSubmitting = false;
                return;
            }
            
            let fechaRegistro = null;
            if (!this.editingLoteId) {
                fechaRegistro = this.getFechaRegistro();
                if (!fechaRegistro) {
                    this.isSubmitting = false;
                    return;
                }
            }
            
            // Deshabilitar el bot√≥n y mostrar loading
            submitBtn.disabled = true;
            submitBtn.setAttribute('data-submitting', 'true'); // Atributo extra para CSS
            submitText.style.display = 'none';
            loadingText.style.display = 'inline';
            
            try {
                const formData = {
                    usuario_id: document.getElementById('usuario_id').value,
                    nombre_miel: document.getElementById('nombre_miel').value,
                    temporadas: temporadas,
                    kg_producidos: parseFloat(document.getElementById('kg_producidos').value),
                    composicion_polen: composicionPolen,
                    orden_miel: parseInt(document.getElementById('orden_miel').value)
                };
                
                if (!this.editingLoteId && fechaRegistro) {
                    formData.fecha_registro = fechaRegistro;
                }
                
                const isEditing = this.editingLoteId !== null;
                const url = isEditing ? `/api/lote/${this.editingLoteId}` : '/api/gestionar-lote';
                const method = isEditing ? 'PUT' : 'POST';
                
                console.log(`Enviando ${method} a ${url}`);
                
                const response = await fetch(url, {
                    method: method,
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(formData),
                    // Evitar cach√© para POST/PUT
                    cache: 'no-cache'
                });
                
                const result = await response.json();
                
                if (result.success) {
                    const mensaje = isEditing ? 'Lote actualizado exitosamente' : 'Lote guardado exitosamente';
                    this.showAlert(mensaje, 'success');
                    
                    if (isEditing) {
                        this.resetForm();
                    } else {
                        this.loteIdSpan.textContent = result.loteId;
                        document.getElementById('lote-orden').textContent = result.data?.orden_miel || 'N/A';
                        this.resultContainer.style.display = 'block';
                        this.form.style.display = 'none';
                    }
                    
                    this.loadLotes();
                } else {
                    this.showAlert(result.error || 'Error al guardar el lote');
                }
            } catch (error) {
                this.showAlert('Error de conexi√≥n: ' + error.message);
            } finally {
                // Restablecer el estado del bot√≥n
                submitBtn.disabled = false;
                submitBtn.removeAttribute('data-submitting');
                submitText.style.display = 'inline';
                loadingText.style.display = 'none';
                
                // Importante: restablecer la bandera de env√≠o
                setTimeout(() => {
                    this.isSubmitting = false;
                    console.log('Formulario listo para nuevo env√≠o');
                }, 500); // Peque√±o retraso para evitar rebotes inmediatos
            }
        }, 100); // 100ms de debounce
    }

    // ===== GESTI√ìN DE LOTES =====
    async loadLotes() {
        try {
            const usuarioId = document.getElementById('usuario_id').value;
            if (!usuarioId) return;
            
            const response = await fetch(`/api/lotes/${usuarioId}`);
            const data = await response.json();
            
            const tbody = document.getElementById('lotes-tbody');
            tbody.innerHTML = '';
            
            const lotes = data.success ? data.lotes : (Array.isArray(data) ? data : []);

            
            if (!lotes || lotes.length === 0) {
                tbody.innerHTML = `
                    <tr><td class="px-4 py-4 text-center text-sm text-gray-500" colspan="7">
                        No hay lotes registrados a√∫n. Crea tu primer lote arriba.
                    </td></tr>
                `;
            } else {
                lotes.forEach(lote => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="px-4 py-2 text-sm text-gray-900">#${lote.orden_miel || 1}</td>
                        <td class="px-4 py-2 text-sm font-medium text-gray-900">${lote.nombre_miel || 'Sin nombre'}</td>
                        <td class="px-4 py-2 text-sm text-gray-900">${lote.temporada || 'N/A'}</td>
                        <td class="px-4 py-2 text-sm text-gray-900">${this.formatDate(lote.fecha_registro)}</td>
                        <td class="px-4 py-2 text-sm text-gray-900 font-mono">${this.formatKg(lote.kg_producidos || 0)} kg</td>
                        <td class="px-4 py-2 text-sm text-gray-900">${lote.composicion || 'Sin datos'}</td>
                        <td class="px-4 py-2 text-sm text-gray-900">
                            <button onclick="loteManager.editLote('${lote.id}')" class="text-blue-600 hover:text-blue-800 mr-2">Editar</button>
                            <button onclick="loteManager.deleteLote('${lote.id}')" class="text-red-600 hover:text-red-800">Eliminar</button>
                        </td>
                    </tr>
                    `;
                    tbody.appendChild(tr);
                });
            }
        } catch (error) {
            const tbody = document.getElementById('lotes-tbody');
            tbody.innerHTML = `
                <tr><td class="px-4 py-4 text-center text-sm text-red-500" colspan="7">
                    Error al cargar lotes. ${error.message}
                </td></tr>
            `;
        }
    }


    async editLote(loteId) {
        try {
            const response = await fetch(`/api/lote/${loteId}`);
            const result = await response.json();
            
            if (result.success) {
                const lote = result.data;
                this.editingLoteId = loteId;
                this.currentLoteData = lote;
                
                document.getElementById('nombre_miel').value = lote.nombre_miel || '';
                document.getElementById('kg_producidos').value = lote.kg_producidos || '';
                document.getElementById('orden_miel').value = lote.orden_miel || '';
                
                this.preloadTemporadas(lote.temporada);
                this.preloadComposicion(lote.composicion);
                
                document.querySelector('.submit-text').textContent = 'Actualizar Lote';
                this.disableDateFields();
                
                this.form.scrollIntoView({ behavior: 'smooth' });
                this.showAlert('Lote cargado para edici√≥n. La fecha de registro no puede modificarse.', 'success');
            } else {
                this.showAlert('Error al cargar el lote: ' + result.error, 'error');
            }
        } catch (error) {
            this.showAlert('Error de conexi√≥n al cargar el lote', 'error');
        }
    }

    async deleteLote(loteId) {
        console.log('‚ö†Ô∏è M√©todo deleteLote llamado con ID:', loteId);
        
        // Intentar obtener informaci√≥n del lote de la tabla en la UI
        // Esta ser√° nuestra fuente de respaldo si la API falla
        let tableRowInfo = this.getLoteInfoFromTable(loteId);
        console.log('üìã Informaci√≥n del lote obtenida de la tabla:', tableRowInfo);
        
        // Guardar el ID del lote en el bot√≥n de confirmaci√≥n inmediatamente
        const confirmDeleteBtn = document.getElementById('btn-confirm-delete');
        confirmDeleteBtn.setAttribute('data-lote-id', loteId);
        
        try {
            // Intentar buscar informaci√≥n del lote para mostrar en el modal - PERO NO BLOQUEAR SI FALLA
            const loteResponse = await fetch(`/api/lote/${loteId}`);
            
            if (loteResponse.ok) {
                const loteData = await loteResponse.json();
                
                if (loteData.success && loteData.data) {
                    const lote = loteData.data;
                    console.log('‚úÖ Datos del lote obtenidos de la API:', lote);
                    
                    // Actualizar el contenido del modal con informaci√≥n del lote
                    // Considerar tanto orden_miel como orden (compatibilidad con estructura antigua)
                    const nombre = lote.nombre_miel || 'Sin nombre';
                    const orden = lote.orden_miel || lote.orden || (tableRowInfo ? tableRowInfo.orden : '-');
                    
                    document.getElementById('modal-lote-nombre').textContent = nombre;
                    document.getElementById('modal-lote-orden').textContent = orden;
                } else {
                    console.warn('‚ö†Ô∏è API retorn√≥ √©xito=false o sin datos');
                    this.setModalInfoFromBackup(tableRowInfo);
                }
            } else {
                console.warn(`‚ö†Ô∏è Error en API: ${loteResponse.status}`);
                this.setModalInfoFromBackup(tableRowInfo);
            }
        } catch (error) {
            console.error('‚ùå Error al cargar datos del lote:', error);
            this.setModalInfoFromBackup(tableRowInfo);
        } finally {
            // Siempre mostrar el modal, incluso si no se pudo cargar la informaci√≥n
            this.openModal();
        }
    }
    
    // Obtener informaci√≥n del lote desde la tabla en la UI
    getLoteInfoFromTable(loteId) {
        try {
            // Buscar la fila con el data-id que coincida con el loteId
            const row = document.querySelector(`tr[data-id="${loteId}"]`);
            if (!row) return null;
            
            // Extraer informaci√≥n de las celdas
            const cells = row.querySelectorAll('td');
            if (cells.length < 2) return null;
            
            // Primera celda suele tener el orden (formato: #X)
            let orden = cells[0].textContent.trim().replace('#', '');
            const nombre = cells[1].textContent.trim();
            
            return { nombre, orden };
        } catch (e) {
            console.error('Error al extraer informaci√≥n de la tabla:', e);
            return null;
        }
    }
    
    // Establecer informaci√≥n en el modal usando datos de respaldo
    setModalInfoFromBackup(tableInfo) {
        if (tableInfo && tableInfo.nombre && tableInfo.orden) {
            document.getElementById('modal-lote-nombre').textContent = tableInfo.nombre;
            document.getElementById('modal-lote-orden').textContent = tableInfo.orden;
            console.log('‚ÑπÔ∏è Usando informaci√≥n de respaldo de la tabla');
        } else {
            // Sin informaci√≥n de respaldo, usar valores por defecto
            document.getElementById('modal-lote-nombre').textContent = 'Lote seleccionado';
            document.getElementById('modal-lote-orden').textContent = 'N/A';
            console.log('‚ÑπÔ∏è Usando valores por defecto');
        }
    }
    
    openModal() {
        const modalOverlay = document.getElementById('delete-modal-overlay');
        modalOverlay.classList.add('active');
    }
    
    closeModal() {
        const modalOverlay = document.getElementById('delete-modal-overlay');
        modalOverlay.classList.remove('active');
    }
    
    async performDelete(loteId) {
        this.closeModal();
        
        try {
            console.log('üì§ Enviando solicitud DELETE a /api/lote/' + loteId);
            const response = await fetch(`/api/lote/${loteId}`, { 
                method: 'DELETE',
                headers: {
                    'Content-Type': 'application/json'
                }
            });
            
            console.log('üì• Respuesta recibida:', response.status, response.statusText);
            const result = await response.json();
            console.log('üìÑ Datos recibidos:', result);
            
            if (result.success) {
                this.showAlert('Lote eliminado exitosamente', 'success');
                this.loadLotes();
            } else {
                console.error('‚ùå Error al eliminar lote:', result.error);
                this.showAlert('Error al eliminar el lote: ' + result.error, 'error');
            }
        } catch (error) {
            console.error('‚ùå Excepci√≥n al eliminar lote:', error);
            this.showAlert('Error de conexi√≥n al eliminar el lote: ' + error.message, 'error');
        }
    }


    // ===== UTILIDADES DE EDICI√ìN =====
    preloadTemporadas(temporadas) {
        document.querySelectorAll('.temporada-checkbox').forEach(cb => cb.checked = false);
        if (temporadas) {
            temporadas.split(',').map(t => t.trim()).forEach(temporada => {
                const checkbox = document.querySelector(`input[value="${temporada}"]`);
                if (checkbox) checkbox.checked = true;
            });
        }
    }

    preloadComposicion(composicion) {
        const container = document.getElementById('composicion-container');
        const filasExistentes = container.querySelectorAll('.composicion-fila');
        for (let i = 1; i < filasExistentes.length; i++) {
            filasExistentes[i].remove();
        }
        
        // Asegurar que las especies est√©n cargadas antes de precargar composici√≥n
        this.loadSpecies().then(() => {
            if (composicion) {
                const composiciones = composicion.split(',').map(c => c.trim());
                const primeraFila = container.querySelector('.composicion-fila');
                
                composiciones.forEach((comp, index) => {
                    const [especie, porcentaje] = comp.split(':');
                    
                    if (index === 0) {
                        primeraFila.querySelector('.composicion-tipo').value = especie.trim();
                        primeraFila.querySelector('.composicion-porcentaje').value = porcentaje.trim();
                    } else {
                        this.createComposicionRow(especie.trim(), porcentaje.trim());
                    }
                });
            }
        });
    }

    createComposicionRow(especie, porcentaje) {
        // Funci√≥n auxiliar para crear filas - reutilizada por preloadComposicion
        const container = document.getElementById('composicion-container');
        const zonaSelect = document.getElementById('especies-zona');
        
        const newRow = document.createElement('div');
        newRow.className = 'flex items-center space-x-2 composicion-fila';
        newRow.innerHTML = `
            <select class="composicion-tipo form-input flex-1">${zonaSelect.innerHTML}</select>
            <input type="number" class="composicion-porcentaje form-input w-24" 
                   placeholder="%" min="0" max="100" step="1" value="${porcentaje}">
            <button type="button" class="btn-remove-composicion text-red-600 hover:text-red-800">‚úï</button>
        `;
        
        container.appendChild(newRow);
        newRow.querySelector('.composicion-tipo').value = especie;
    }

    disableDateFields() {
        ['dia_registro', 'mes_registro', 'anio_registro'].forEach(id => {
            const element = document.getElementById(id);
            if (element) element.disabled = true;
        });
        const fechaHoy = document.getElementById('fecha-hoy');
        if (fechaHoy) fechaHoy.style.display = 'none';
        
        // Mostrar la fecha de registro actual del lote en modo informativo
        if (this.currentLoteData && this.currentLoteData.fecha_registro) {
            const fechaContainer = document.querySelector('#dia_registro')?.closest('.form-group');
            if (fechaContainer && !fechaContainer.querySelector('.fecha-no-modificable')) {
                const mensaje = document.createElement('div');
                mensaje.className = 'fecha-no-modificable text-orange-600 mt-2 p-2 bg-orange-50 rounded border';
                mensaje.innerHTML = `
                    <strong>üìÖ Fecha de registro original:</strong> ${this.formatDate(this.currentLoteData.fecha_registro)}<br>
                    <small>‚ö†Ô∏è La fecha de registro no puede modificarse (dataci√≥n oficial)</small>
                `;
                fechaContainer.appendChild(mensaje);
            }
        }
    }

    enableDateFields() {
        ['dia_registro', 'mes_registro', 'anio_registro'].forEach(id => {
            document.getElementById(id).disabled = false;
        });
        document.getElementById('fecha-hoy').style.display = 'inline';
        
        const mensajeFecha = document.querySelector('.fecha-no-modificable');
        if (mensajeFecha) mensajeFecha.remove();
    }

    // ===== FORMATEO =====
    formatKg(kg) {
        return parseFloat(kg).toFixed(2);
    }

    formatDate(fechaISO) {
        if (!fechaISO) return 'N/A';
        const fecha = new Date(fechaISO);
        const dia = fecha.getDate().toString().padStart(2, '0');
        const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
        const anio = fecha.getFullYear();
        return `${dia}/${mes}/${anio}`;
    }
}

// ===== FUNCIONES GLOBALES =====
function resetForm() { loteManager.resetForm(); }
function viewLotes() { document.getElementById('lotes-list').scrollIntoView({ behavior: 'smooth' }); }

// ===== INICIALIZACI√ìN =====
let loteManager;

// Funci√≥n global para asegurarnos que loteManager est√° disponible
function initLoteManager() {
    console.log('üîÑ Intentando inicializar loteManager...');
    if (!loteManager) {
        console.log('‚ú® Creando nueva instancia de LoteManager');
        loteManager = new LoteManager();
        loteManager.init();
    }
    return loteManager;
}

// Inicializaci√≥n cuando el DOM est√° cargado
document.addEventListener('DOMContentLoaded', () => {
    console.log('üöÄ DOM cargado, inicializando loteManager');
    initLoteManager();
});

// Asegurar que loteManager est√° disponible globalmente
window.loteManager = initLoteManager();

// Debug global
console.log('üìã Script cargado, loteManager ser√°:', typeof loteManager);
</script>
{% endblock %}
