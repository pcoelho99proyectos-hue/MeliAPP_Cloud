{% extends "base/layout.html" %}

{% block title %}Gesti√≥n de Lotes de Miel - MeliAPP{% endblock %}
{% block description %}Sistema para gestionar lotes de miel en producci√≥n ap√≠cola{% endblock %}

{% block extra_head %}
<style>
    .form-container {
        max-width: 600px;
        margin: 0 auto;
    }
    .form-group {
        margin-bottom: 1.5rem;
    }
    .form-label {
        display: block;
        font-weight: 600;
        color: #374151;
        margin-bottom: 0.5rem;
    }
    .form-input {
        width: 100%;
        padding: 0.75rem;
        border: 1px solid #d1d5db;
        border-radius: 0.375rem;
        font-size: 1rem;
    }
    .form-input:focus {
        outline: none;
        border-color: #f59e0b;
        box-shadow: 0 0 0 3px rgba(245, 158, 11, 0.1);
    }
    .form-textarea {
        min-height: 100px;
        resize: vertical;
    }
    .btn-primary {
        background-color: #f59e0b;
        color: white;
        padding: 0.75rem 1.5rem;
        border-radius: 0.375rem;
        font-weight: 600;
        border: none;
        cursor: pointer;
        transition: background-color 0.2s;
    }
    .btn-primary:hover {
        background-color: #d97706;
    }
    .btn-primary:disabled {
        background-color: #9ca3af;
        cursor: not-allowed;
    }
    .alert {
        padding: 1rem;
        border-radius: 0.375rem;
        margin-bottom: 1rem;
    }
    .alert-success {
        background-color: #d1fae5;
        color: #065f46;
        border: 1px solid #a7f3d0;
    }
    .alert-error {
        background-color: #fee2e2;
        color: #991b1b;
        border: 1px solid #fca5a5;
    }
    .loading {
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="text-center mb-8">
        <h1 class="text-3xl font-bold text-gray-900 mb-2">Gesti√≥n de Lotes de Miel</h1>
        <p class="text-gray-600">Registra y actualiza informaci√≥n de tus lotes de producci√≥n ap√≠cola</p>
    </div>

    <div class="form-container">
        <div id="alert-container"></div>
        
        <form id="lote-form" class="bg-white shadow-lg rounded-lg p-6">
            <input type="hidden" id="usuario_id" name="usuario_id" value="{{ session['user_id'] if session.get('user_id') else '' }}">
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                    <label class="form-label" for="nombre_miel">Nombre de la Miel</label>
                    <input type="text" id="nombre_miel" name="nombre_miel" class="form-input" 
                           placeholder="Ej: Miel de Ulmo Primavera" required>
                </div>

                <div class="form-group">
                    <label class="form-label">Temporadas de Cosecha</label>
                    <div class="temporadas-container bg-gray-50 p-4 rounded-lg border">
                        <div class="space-y-3 mb-4">
                            <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                <input type="checkbox" name="temporadas" value="PRIMAVERA" class="temporada-checkbox">
                                <span class="text-sm font-medium">üå∏ Primavera</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                <input type="checkbox" name="temporadas" value="VERANO" class="temporada-checkbox">
                                <span class="text-sm font-medium">‚òÄÔ∏è Verano</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                <input type="checkbox" name="temporadas" value="OTO√ëO" class="temporada-checkbox">
                                <span class="text-sm font-medium">üçÇ Oto√±o</span>
                            </label>
                            <label class="flex items-center space-x-3 cursor-pointer hover:bg-gray-100 p-2 rounded">
                                <input type="checkbox" name="temporadas" value="INVIERNO" class="temporada-checkbox">
                                <span class="text-sm font-medium">‚ùÑÔ∏è Invierno</span>
                            </label>
                        </div>
                        <div class="form-group">
                            <label class="form-label" for="anio_cosecha">A√±o de Cosecha</label>
                            <select id="anio_cosecha" name="anio_cosecha" class="form-input" required>
                                <option value="">Selecciona a√±o</option>
                            </select>
                        </div>
                    </div>
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="form-group">
                    <label class="form-label" for="kg_producidos">Kilogramos Producidos</label>
                    <input type="number" id="kg_producidos" name="kg_producidos" class="form-input" 
                           placeholder="Ej: 150.50" min="0" max="99999.99" 
                           step="0.01" pattern="^\d+(\.\d{1,2})?$" required>
                    <small class="text-gray-500">Formato: n√∫mero entero con hasta 2 decimales (ej: 150.50)</small>
                </div>

                <div class="form-group">
                    <label class="form-label">Fecha de Registro</label>
                    <div class="date-picker-container">
                        <div class="grid grid-cols-3 gap-2">
                            <div>
                                <label class="text-xs text-gray-600">D√≠a</label>
                                <select id="dia_registro" name="dia_registro" class="form-input text-sm" required>
                                    <option value="">D√≠a</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-gray-600">Mes</label>
                                <select id="mes_registro" name="mes_registro" class="form-input text-sm" required>
                                    <option value="">Mes</option>
                                    <option value="1">Enero</option>
                                    <option value="2">Febrero</option>
                                    <option value="3">Marzo</option>
                                    <option value="4">Abril</option>
                                    <option value="5">Mayo</option>
                                    <option value="6">Junio</option>
                                    <option value="7">Julio</option>
                                    <option value="8">Agosto</option>
                                    <option value="9">Septiembre</option>
                                    <option value="10">Octubre</option>
                                    <option value="11">Noviembre</option>
                                    <option value="12">Diciembre</option>
                                </select>
                            </div>
                            <div>
                                <label class="text-xs text-gray-600">A√±o</label>
                                <select id="anio_registro" name="anio_registro" class="form-input text-sm" required>
                                    <option value="">A√±o</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-2">
                            <button type="button" id="fecha-hoy" class="text-sm text-blue-600 hover:text-blue-800">
                                üìÖ Usar fecha de hoy
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="form-group">
                <label class="form-label">Composici√≥n de Polen por Zona</label>
                <div id="composicion-container" class="space-y-2">
                    <div class="flex items-center space-x-2">
                        <select class="composicion-tipo form-input flex-1" id="especies-zona">
                            <option value="">Cargando especies de tu zona...</option>
                        </select>
                        <input type="number" class="composicion-porcentaje form-input w-24" 
                               placeholder="%" min="0" max="100" step="1">
                        <button type="button" class="btn-remove-composicion text-red-600 hover:text-red-800">
                            ‚úï
                        </button>
                    </div>
                </div>
                <button type="button" id="add-composicion" class="text-sm text-blue-600 hover:text-blue-800">
                    + Agregar especie
                </button>
                <small class="text-gray-500" id="zona-info">Las especies se cargar√°n seg√∫n tu comuna registrada</small>
            </div>

            <div class="flex space-x-4">
                <button type="submit" class="btn-primary flex-1">
                    <span class="submit-text">Guardar Lote</span>
                    <span class="loading">Guardando...</span>
                </button>
                <button type="button" onclick="resetForm()" class="bg-gray-500 text-white px-4 py-2 rounded hover:bg-gray-600">
                    Limpiar Formulario
                </button>
            </div>
        </form>

        <div id="result-container" class="mt-6" style="display: none;">
            <div class="bg-green-50 border border-green-200 rounded-lg p-4">
                <h3 class="text-lg font-semibold text-green-800 mb-2">‚úÖ Lote Guardado Exitosamente</h3>
                <p class="text-green-700">ID del lote: <span id="lote-id" class="font-mono"></span></p>
                <p class="text-green-700">Orden: <span id="lote-orden" class="font-mono"></span></p>
                <div class="mt-4 flex space-x-4">
                    <button onclick="resetForm()" class="bg-green-600 text-white px-4 py-2 rounded hover:bg-green-700">
                        Registrar otro lote
                    </button>
                    <button onclick="viewLotes()" class="bg-blue-600 text-white px-4 py-2 rounded hover:bg-blue-700">
                        Ver mis lotes
                    </button>
                </div>
            </div>
        </div>

        <div id="lotes-list" class="mt-8">
            <h2 class="text-2xl font-bold text-gray-900 mb-4">Mis Lotes de Miel Registrados</h2>
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white border border-gray-200 rounded-lg" id="tabla-lotes">
                    <thead class="bg-gray-50">
                        <tr>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Orden</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Nombre</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Temporada</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Fecha Origen</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Kilogramos</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Composici√≥n</th>
                            <th class="px-4 py-2 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Acciones</th>
                        </tr>
                    </thead>
                    <tbody id="lotes-tbody" class="divide-y divide-gray-200">
                        <!-- Los lotes se cargar√°n din√°micamente -->
                        <tr class="hover:bg-gray-50">
                            <td class="px-4 py-4 text-center text-sm text-gray-500" colspan="7">
                                No hay lotes registrados a√∫n. Crea tu primer lote arriba.
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    const form = document.getElementById('lote-form');
    const alertContainer = document.getElementById('alert-container');
    const resultContainer = document.getElementById('result-container');
    const loteIdSpan = document.getElementById('lote-id');

    function showAlert(message, type = 'error') {
        alertContainer.innerHTML = '';
        const alert = document.createElement('div');
        alert.className = `alert alert-${type}`;
        alert.textContent = message;
        alertContainer.appendChild(alert);
        
        if (type === 'success') {
            setTimeout(() => alert.remove(), 5000);
        }
    }

    function resetForm() {
        form.reset();
        resultContainer.style.display = 'none';
        alertContainer.innerHTML = '';
    }

    // Funci√≥n para obtener composici√≥n pol√≠nica en formato JSON num√©rico
    function getComposicionPolen() {
        const composicion = {};
        const filas = document.querySelectorAll('.composicion-fila');
        let totalPorcentaje = 0;
        
        filas.forEach(fila => {
            const tipo = fila.querySelector('.composicion-tipo').value;
            const porcentaje = parseFloat(fila.querySelector('.composicion-porcentaje').value) || 0;
            
            if (tipo && porcentaje > 0) {
                // Almacenar como n√∫mero sin s√≠mbolo de porcentaje
                composicion[tipo] = porcentaje;
                totalPorcentaje += porcentaje;
            }
        });
        
        if (totalPorcentaje > 100) {
            showAlert('La suma de porcentajes no puede exceder 100%', 'error');
            return null;
        }
        
        return composicion;
    }

    // Funci√≥n para obtener temporadas seleccionadas
    function getTemporadasSeleccionadas() {
        const checkboxes = document.querySelectorAll('.temporada-checkbox:checked');
        
        if (checkboxes.length === 0) {
            showAlert('Debe seleccionar al menos una temporada', 'error');
            return null;
        }
        
        const temporadas = Array.from(checkboxes).map(cb => cb.value);
        return temporadas.join(' - '); // Formato: "VERANO - OTO√ëO"
    }

    // Funci√≥n para obtener fecha de registro manual
    function getFechaRegistro() {
        const dia = document.getElementById('dia_registro').value;
        const mes = document.getElementById('mes_registro').value;
        const anio = document.getElementById('anio_registro').value;
        
        if (!dia || !mes || !anio) {
            showAlert('Debe completar la fecha de registro', 'error');
            return null;
        }
        
        // Validar fecha
        const fecha = new Date(anio, mes - 1, dia);
        if (fecha.getDate() != dia || fecha.getMonth() != mes - 1 || fecha.getFullYear() != anio) {
            showAlert('Fecha de registro inv√°lida', 'error');
            return null;
        }
        
        // Formato ISO para PostgreSQL (YYYY-MM-DD)
        return `${anio}-${mes.padStart(2, '0')}-${dia.padStart(2, '0')}`;
    }

    // Funci√≥n para inicializar selectores de fecha
    function inicializarSelectoresFecha() {
        // Llenar d√≠as (1-31)
        const diaSelect = document.getElementById('dia_registro');
        for (let i = 1; i <= 31; i++) {
            const option = document.createElement('option');
            option.value = i;
            option.textContent = i;
            diaSelect.appendChild(option);
        }
        
        // Llenar a√±os (1990 hasta a√±o actual)
        const anioRegistroSelect = document.getElementById('anio_registro');
        const anioCosechaSelect = document.getElementById('anio_cosecha');
        const anioActual = new Date().getFullYear();
        
        for (let i = anioActual; i >= 1990; i--) {
            // A√±o de registro
            const optionRegistro = document.createElement('option');
            optionRegistro.value = i;
            optionRegistro.textContent = i;
            anioRegistroSelect.appendChild(optionRegistro);
            
            // A√±o de cosecha
            const optionCosecha = document.createElement('option');
            optionCosecha.value = i;
            optionCosecha.textContent = i;
            anioCosechaSelect.appendChild(optionCosecha);
        }
        
        // Bot√≥n "Usar fecha de hoy"
        document.getElementById('fecha-hoy').addEventListener('click', function() {
            const hoy = new Date();
            document.getElementById('dia_registro').value = hoy.getDate();
            document.getElementById('mes_registro').value = hoy.getMonth() + 1;
            document.getElementById('anio_registro').value = hoy.getFullYear();
        });
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        
        const submitBtn = form.querySelector('button[type="submit"]');
        const submitText = submitBtn.querySelector('.submit-text');
        const loadingText = submitBtn.querySelector('.loading');
        
        // Validar composici√≥n pol√≠nica
        const composicionPolen = getComposicionPolen();
        if (composicionPolen === null) {
            return;
        }
        
        // Deshabilitar bot√≥n y mostrar loading
        submitBtn.disabled = true;
        submitText.style.display = 'none';
        loadingText.style.display = 'inline';
        
        try {
            const usuarioId = document.getElementById('usuario_id').value;
            // Obtener temporadas y fecha de registro
            const temporadas = getTemporadasSeleccionadas();
            const fechaRegistro = getFechaRegistro();
            
            if (!temporadas || !fechaRegistro) {
                return; // Los errores ya se mostraron en las funciones
            }
            
            const formData = {
                usuario_id: usuarioId,
                nombre_miel: document.getElementById('nombre_miel').value,
                temporadas: temporadas,
                kg_producidos: parseFloat(document.getElementById('kg_producidos').value),
                composicion_polen: composicionPolen,
                fecha_registro: fechaRegistro
            };
            
            const response = await fetch('/api/gestionar-lote', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify(formData)
            });
            
            const result = await response.json();
            
            if (result.success) {
                showAlert('Lote guardado exitosamente', 'success');
                loteIdSpan.textContent = result.loteId;
                document.getElementById('lote-orden').textContent = result.data?.orden || 'N/A';
                resultContainer.style.display = 'block';
                form.style.display = 'none';
                
                // Cargar lotes actualizados
                loadLotes();
            } else {
                showAlert(result.error || 'Error al guardar el lote');
            }
        } catch (error) {
            showAlert('Error de conexi√≥n: ' + error.message);
        } finally {
            submitBtn.disabled = false;
            submitText.style.display = 'inline';
            loadingText.style.display = 'none';
        }
    });

    async function cargarEspeciesPorZona() {
        console.log('üöÄ FRONTEND: Iniciando carga de especies por zona');
        
        try {
            const usuarioId = document.getElementById('usuario_id').value;
            console.log('üîç FRONTEND: Usuario ID detectado:', usuarioId);
            
            if (!usuarioId) {
                console.error('‚ùå FRONTEND: No se encontr√≥ usuario ID');
                mostrarEstadoEspecies('error', 'No se pudo identificar al usuario');
                return;
            }
            
            // Mostrar estado de carga
            mostrarEstadoEspecies('loading', 'Verificando tu zona geogr√°fica...');
            
            console.log('üåç FRONTEND: Consultando especies para zona del usuario...');
            
            // Debug de la petici√≥n HTTP
            console.log('üîó FRONTEND: URL de petici√≥n:', `/api/usuario-info/${usuarioId}`);
            
            const response = await fetch(`/api/usuario-info/${usuarioId}`);
            
            console.log('üìä FRONTEND: Response status:', response.status);
            console.log('üìä FRONTEND: Response ok:', response.ok);
            console.log('üìä FRONTEND: Response headers:', response.headers);
            
            if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
            }
            
            const data = await response.json();
            console.log('üìä FRONTEND: Respuesta del servidor:', data);
            
            if (data.success && data.especies && data.especies.length > 0) {
                console.log(`‚úÖ FRONTEND: Especies encontradas para ${data.comuna}:`, data.especies);
                
                // Actualizar selector de especies
                const especiesSelect = document.getElementById('especies-zona');
                especiesSelect.innerHTML = '<option value="">Selecciona especie de tu zona</option>';
                
                console.log('üå∏ FRONTEND: Agregando especies al dropdown:', data.especies);
                data.especies.forEach(especie => {
                    const option = document.createElement('option');
                    option.value = especie;
                    option.textContent = especie;
                    especiesSelect.appendChild(option);
                });
                
                // Verificar que el dropdown se actualiz√≥
                console.log('üå∏ FRONTEND: Total opciones en dropdown:', especiesSelect.options.length);
                
                // Mostrar informaci√≥n de zona
                mostrarEstadoEspecies('success', 
                    `üå∏ ${data.total_especies} especies disponibles para ${data.comuna}`);
                
                // Actualizar selects de composici√≥n pol√≠nica
                actualizarOpcionesComposicion(data.especies);
                
                console.log('‚ú® FRONTEND: Especies cargadas exitosamente');
                
            } else {
                console.warn('‚ö†Ô∏è FRONTEND: No se encontraron especies:', data.message);
                mostrarEstadoEspecies('warning', data.message || 'No hay especies para tu zona');
                
                const especiesSelect = document.getElementById('especies-zona');
                especiesSelect.innerHTML = '<option value="">Sin especies disponibles</option>';
            }
        } catch (error) {
            console.error('‚ùå FRONTEND: Error completo:', error);
            console.error('‚ùå FRONTEND: Tipo de error:', error.name);
            console.error('‚ùå FRONTEND: Mensaje:', error.message);
            console.error('‚ùå FRONTEND: Stack trace:', error.stack);
            
            // Error m√°s espec√≠fico
            let mensajeError = 'Error de conexi√≥n al verificar especies';
            if (error.name === 'TypeError') {
                mensajeError = 'Error de red - Verifica tu conexi√≥n';
            } else if (error.name === 'SyntaxError') {
                mensajeError = 'Error de respuesta del servidor';
            }
            
            mostrarEstadoEspecies('error', mensajeError);
            
            const especiesSelect = document.getElementById('especies-zona');
            if (especiesSelect) {
                especiesSelect.innerHTML = '<option value="">Error al cargar</option>';
            }
        }
    }
    
    function mostrarEstadoEspecies(tipo, mensaje) {
        const zonaInfo = document.getElementById('zona-info');
        const iconos = {
            'loading': 'üîÑ',
            'success': '‚úÖ',
            'warning': '‚ö†Ô∏è',
            'error': '‚ùå'
        };
        
        const clases = {
            'loading': 'text-sm text-blue-600',
            'success': 'text-sm text-green-600',
            'warning': 'text-sm text-yellow-600',
            'error': 'text-sm text-red-600'
        };
        
        zonaInfo.textContent = `${iconos[tipo]} ${mensaje}`;
        zonaInfo.className = clases[tipo];
    }

    // Funci√≥n para formatear kilogramos con 2 decimales
    function formatearKilogramos(kg) {
        return parseFloat(kg).toFixed(2);
    }

    // Funci√≥n para formatear fecha de ISO a DD/MM/AAAA
    function formatearFecha(fechaISO) {
        if (!fechaISO) return 'N/A';
        const fecha = new Date(fechaISO);
        const dia = fecha.getDate().toString().padStart(2, '0');
        const mes = (fecha.getMonth() + 1).toString().padStart(2, '0');
        const anio = fecha.getFullYear();
        return `${dia}/${mes}/${anio}`;
    }

    // Funci√≥n mejorada para cargar lotes en tabla
    async function loadLotes() {
        try {
            const usuarioId = document.getElementById('usuario_id').value;
            if (!usuarioId) return;
            
            const response = await fetch(`/api/lotes/${usuarioId}`);
            const lotes = await response.json();
            
            const tbody = document.getElementById('lotes-tbody');
            tbody.innerHTML = '';
            
            if (lotes.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td class="px-4 py-4 text-center text-sm text-gray-500" colspan="7">
                            No hay lotes registrados a√∫n. Crea tu primer lote arriba.
                        </td>
                    </tr>
                `;
            } else {
                lotes.forEach(lote => {
                    const tr = document.createElement('tr');
                    tr.className = 'hover:bg-gray-50';
                    tr.innerHTML = `
                        <td class="px-4 py-2 text-sm text-gray-900">#${lote.orden_miel || 1}</td>
                        <td class="px-4 py-2 text-sm font-medium text-gray-900">${lote.nombre_miel || 'Sin nombre'}</td>
                        <td class="px-4 py-2 text-sm text-gray-900">${lote.temporada || 'N/A'}</td>
                        <td class="px-4 py-2 text-sm text-gray-900">${formatearFecha(lote.fecha_registro)}</td>
                        <td class="px-4 py-2 text-sm text-gray-900 font-mono">${formatearKilogramos(lote.kg_producidos || 0)} kg</td>
                        <td class="px-4 py-2 text-sm text-gray-900">
                            ${lote.composicion_polen ? Object.entries(lote.composicion_polen)
                                .map(([especie, porcentaje]) => `${especie}: ${porcentaje}%`)
                                .join(', ') : 'Sin datos'}
                        </td>
                        <td class="px-4 py-2 text-sm text-gray-900">
                            <button onclick="editarLote('${lote.id}')" class="text-blue-600 hover:text-blue-800 mr-2">
                                Editar
                            </button>
                            <button onclick="eliminarLote('${lote.id}')" class="text-red-600 hover:text-red-800">
                                Eliminar
                            </button>
                        </td>
                    </tr>
                `;
                    tbody.appendChild(tr);
                });
            }
        } catch (error) {
            console.error('Error al cargar lotes:', error);
            const tbody = document.getElementById('lotes-tbody');
            tbody.innerHTML = `
                <tr>
                    <td class="px-4 py-4 text-center text-sm text-red-500" colspan="7">
                        Error al cargar lotes. Por favor, intenta nuevamente.
                    </td>
                </tr>
            `;
        }
    }

    // Funci√≥n para ver lotes
    function viewLotes() {
        loadLotes();
        document.getElementById('result-container').style.display = 'none';
        document.getElementById('lotes-list').style.display = 'block';
    }

    // Funci√≥n para actualizar opciones de composici√≥n
    function actualizarOpcionesComposicion(especies) {
        console.log('üå∏ FRONTEND: Actualizando opciones de composici√≥n con:', especies);
        
        // Actualizar el dropdown principal
        const especiesSelect = document.getElementById('especies-zona');
        if (especiesSelect) {
            especiesSelect.innerHTML = '<option value="">Selecciona especie de tu zona</option>';
            especies.forEach(especie => {
                const option = document.createElement('option');
                option.value = especie;
                option.textContent = especie;
                especiesSelect.appendChild(option);
            });
        }
        
        // Actualizar todos los selects de composici√≥n existentes
        const composicionSelects = document.querySelectorAll('.composicion-tipo');
        composicionSelects.forEach(select => {
            const valorActual = select.value;
            select.innerHTML = '<option value="">Selecciona especie</option>';
            
            especies.forEach(especie => {
                const option = document.createElement('option');
                option.value = especie;
                option.textContent = especie;
                if (especie === valorActual) option.selected = true;
                select.appendChild(option);
            });
        });
    }

    // Funciones para editar y eliminar lotes
    function editarLote(loteId) {
        // Implementar edici√≥n de lote
        console.log('Editar lote:', loteId);
        // Aqu√≠ podr√≠as cargar los datos del lote en el formulario
    }

    function eliminarLote(loteId) {
        if (confirm('¬øEst√°s seguro de eliminar este lote?')) {
            // Implementar eliminaci√≥n
            console.log('Eliminar lote:', loteId);
        }
    }

    // Sistema de composici√≥n din√°mica con especies por zona
    document.getElementById('add-composicion').addEventListener('click', function() {
        const container = document.getElementById('composicion-container');
        const zonaSelect = document.getElementById('especies-zona');
        
        const newRow = document.createElement('div');
        newRow.className = 'flex items-center space-x-2 composicion-fila';
        
        // Copiar las opciones del select principal
        const optionsHTML = zonaSelect.innerHTML;
        
        newRow.innerHTML = `
            <select class="composicion-tipo form-input flex-1">
                ${optionsHTML}
            </select>
            <input type="number" class="composicion-porcentaje form-input w-24" 
                   placeholder="%" min="0" max="100" step="1">
            <button type="button" class="btn-remove-composicion text-red-600 hover:text-red-800">
                ‚úï
            </button>
        `;
        container.appendChild(newRow);
        
        // Event listener para eliminar
        newRow.querySelector('.btn-remove-composicion').addEventListener('click', function() {
            newRow.remove();
        });
    });

    // Inicializar al cargar la p√°gina
    document.addEventListener('DOMContentLoaded', function() {
        console.log('üíª FRONTEND: P√°gina cargada');
        
        // Inicializar selectores de fecha
        inicializarSelectoresFecha();
        
        // Cargar especies autom√°ticamente
        setTimeout(() => {
            cargarEspeciesPorZona();
        }, 500);
        
        loadLotes();
        
        // Agregar verificaci√≥n en tiempo real al selector de especies
        if (especiesSelect) {
            especiesSelect.addEventListener('click', function() {
                console.log('üíÜ FRONTEND: Click en selector de especies - Verificando estado...');
                const usuarioId = document.getElementById('usuario_id').value;
                if (usuarioId) {
                    console.log('üîÑ FRONTEND: Re-verificando especies disponibles...');
                    cargarEspeciesPorZona();
                } else {
                    console.error('‚ùå FRONTEND: No hay usuario ID al hacer click');
                }
            });
        }
        
        // Verificaci√≥n en tiempo real para composici√≥n pol√≠nica
        const composicionSelects = document.querySelectorAll('[id^="composicion-"]');
        composicionSelects.forEach(select => {
            select.addEventListener('focus', function() {
                console.log('üåº FRONTEND: Focus en composici√≥n pol√≠nica - Verificando opciones...');
                const usuarioId = document.getElementById('usuario_id').value;
                if (usuarioId) {
                    // Verificar que las opciones est√©n actualizadas
                    verificarOpcionesComposicion();
                }
            });
        });
    });
    
    function verificarOpcionesComposicion() {
        const especiesSelect = document.getElementById('especies-zona');
        const especiesDisponibles = Array.from(especiesSelect.options)
            .slice(1) // Omitir la primera opci√≥n "Selecciona..."
            .map(option => option.value)
            .filter(value => value !== '');
            
        if (especiesDisponibles.length > 0) {
            console.log('‚úÖ FRONTEND: Opciones de composici√≥n verificadas:', especiesDisponibles);
            actualizarOpcionesComposicion(especiesDisponibles);
        } else {
            console.warn('‚ö†Ô∏è FRONTEND: No hay especies disponibles para composici√≥n');
        }
    }

    // Funci√≥n para actualizar opciones de composici√≥n pol√≠nica
    function actualizarOpcionesComposicion(especies) {
        console.log('üîÑ FRONTEND: Actualizando opciones de composici√≥n con especies:', especies);
        
        // Actualizar todos los selects de composici√≥n existentes
        const composicionSelects = document.querySelectorAll('.composicion-tipo');
        
        composicionSelects.forEach(select => {
            const valorActual = select.value;
            select.innerHTML = '<option value="">Selecciona especie</option>';
            
            especies.forEach(especie => {
                const option = document.createElement('option');
                option.value = especie;
                option.textContent = especie;
                if (especie === valorActual) {
                    option.selected = true;
                }
                select.appendChild(option);
            });
        });
        
        console.log('‚úÖ FRONTEND: Opciones de composici√≥n actualizadas');
    }

    // Event listener para eliminar composiciones existentes
    document.addEventListener('click', function(e) {
        if (e.target.classList.contains('btn-remove-composicion')) {
            e.target.closest('.composicion-fila').remove();
        }
    });
</script>
{% endblock %}
