{% extends "base/layout.html" %}

{% block title %}Editar Perfil - MeliAPP{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 dark:from-slate-800 dark:to-slate-900 py-8 transition-colors duration-300">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg mb-6">
            <div class="px-6 py-4 border-b border-gray-200 dark:border-slate-600">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900 dark:text-slate-100"> Editar Informaci贸n Personal</h1>
                        <p class="text-sm text-gray-600 dark:text-slate-300 mt-1">Actualiza tus datos personales de forma segura</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg mb-6 transition-colors duration-300">
            <div class="px-4 sm:px-6 py-4">
                <nav class="flex flex-wrap gap-2 sm:space-x-8 sm:gap-0 border-b border-gray-200 dark:border-slate-600">
                    <button onclick="showTab('usuarios')" id="tab-usuarios" class="tab-btn py-2 sm:py-3 px-2 sm:px-1 border-b-2 border-amber-500 text-amber-600 dark:text-amber-400 font-medium text-sm sm:text-base flex-1 sm:flex-none">
                        <i class="fas fa-user mr-1 sm:mr-2"></i><span class="hidden sm:inline">Usuario</span><span class="sm:hidden">User</span>
                    </button>
                    <button onclick="showTab('info_contacto')" id="tab-info_contacto" class="tab-btn py-2 sm:py-3 px-2 sm:px-1 border-b-2 border-transparent text-gray-500 dark:text-slate-400 hover:text-gray-700 dark:hover:text-slate-300 text-sm sm:text-base flex-1 sm:flex-none">
                        <i class="fas fa-address-card mr-1 sm:mr-2"></i><span class="hidden sm:inline">Contacto</span><span class="sm:hidden">Info</span>
                    </button>
                    <button onclick="showTab('ubicaciones')" id="tab-ubicaciones" class="tab-btn py-2 sm:py-3 px-2 sm:px-1 border-b-2 border-transparent text-gray-500 dark:text-slate-400 hover:text-gray-700 dark:hover:text-slate-300 text-sm sm:text-base flex-1 sm:flex-none">
                        <i class="fas fa-map-marker-alt mr-1 sm:mr-2"></i><span class="hidden sm:inline">Ubicaci贸n</span><span class="sm:hidden">Lugar</span>
                    </button>
                    <button onclick="showTab('seguridad')" id="tab-seguridad" class="tab-btn py-2 sm:py-3 px-2 sm:px-1 border-b-2 border-transparent text-gray-500 dark:text-slate-400 hover:text-gray-700 dark:hover:text-slate-300 text-sm sm:text-base flex-1 sm:flex-none">
                        <i class="fas fa-shield-alt mr-1 sm:mr-2"></i><span class="hidden sm:inline">Seguridad</span><span class="sm:hidden">Seg</span>
                    </button>
                </nav>
            </div>
        </div>

        <!-- Forms Container -->
        <div class="bg-white dark:bg-slate-800 rounded-xl shadow-lg transition-colors duration-300">
            <div class="px-4 sm:px-6 py-6 sm:py-8">
                
                <!-- USUARIOS FORM -->
                <div id="form-usuarios" class="tab-content">
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 dark:text-slate-100 mb-2">Datos de Usuario</h3>
                        <p class="text-sm text-gray-600 dark:text-slate-300">Edita tu tipo de usuario. El nombre de usuario es igual al nombre completo.</p>
                    </div>
                    
                    <form onsubmit="submitForm(event, 'usuarios')" class="space-y-4 sm:space-y-6">
                        <div class="grid grid-cols-1 gap-4 sm:gap-6">
                            <!-- Username (no editable) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">Nombre de Usuario</label>
                                <div class="w-full px-3 py-2 border border-gray-300 dark:border-slate-600 rounded-md bg-gray-50 dark:bg-slate-700 text-gray-700 dark:text-slate-300 transition-colors duration-300" id="usuarios-username-display">
                                    <!-- Se llena autom谩ticamente con el nombre completo -->
                                </div>
                                <p class="text-xs text-gray-500 dark:text-slate-400 mt-1">El nombre de usuario es igual al correo sin "@DominioCorreo.com"</p>
                            </div>
                            
                            <!-- Tipo Usuario (editable) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-slate-300 mb-2">Tipo de Usuario *</label>
                                <select name="tipo_usuario" 
                                        id="usuarios-tipo_usuario" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                        required>
                                    <option value="">Seleccionar tipo...</option>
                                    <option value="apicultor"> Apicultor</option>
                                    <option value="prestador_servicios"> Prestador de Servicios</option>
                                    <option value="proveedor"> Proveedor</option>
                                    <option value="regular"> Regular</option>
                                </select>
                            </div>
                        </div>
                        
                        <!-- Role (mantener para compatibilidad) -->
                        <input type="hidden" name="role" id="usuarios-role" value="regular">
                        
                        <button type="submit" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-medium py-2 sm:py-3 px-4 rounded-lg transition-colors text-sm sm:text-base">
                            <i class="fas fa-save mr-2"></i>Guardar y Continuar a Contacto
                        </button>
                    </form>
                </div>

                <!-- SEGURIDAD FORM -->
                <div id="form-seguridad" class="tab-content hidden">
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Cambiar Contrase帽a</h3>
                        <p class="text-sm text-gray-600">Actualiza tu contrase帽a. Se recomienda usar una contrase帽a segura.</p>
                    </div>
                    
                    <form onsubmit="submitPasswordChange(event)" class="space-y-6">
                        <div class="grid grid-cols-1 gap-6">
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Contrase帽a Actual</label>
                                <input type="password" id="current-password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500" required>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nueva Contrase帽a</label>
                                <input type="password" id="new-password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500" required minlength="6">
                                <p class="text-xs text-gray-500 mt-1">Debe tener al menos 6 caracteres.</p>
                            </div>
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Confirmar Nueva Contrase帽a</label>
                                <input type="password" id="confirm-new-password" class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500" required>
                            </div>
                        </div>
                        
                        <button type="submit" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                            <i class="fas fa-key mr-2"></i>Actualizar Contrase帽a
                        </button>
                    </form>

                    <hr class="my-8 border-gray-300">

                    <div>
                        <h3 class="text-xl font-semibold text-gray-800 mb-2">Recuperar por correo</h3>
                        <p class="text-gray-600 mb-4">Si lo prefieres, puedes solicitar un enlace de recuperaci贸n a tu correo electr贸nico para cambiar tu contrase帽a desde all铆.</p>
                        <div class="flex justify-start">
                            <button onclick="requestPasswordReset()" id="request-reset-btn" class="bg-gray-600 hover:bg-gray-700 text-white font-bold py-2 px-6 rounded-lg shadow-md transition-transform transform hover:scale-105 focus:outline-none focus:ring-2 focus:ring-gray-500 focus:ring-opacity-75">
                                <i class="fas fa-envelope mr-2"></i>Enviar enlace de recuperaci贸n
                            </button>
                        </div>
                    </div>
                </div>

                <!-- INFO_CONTACTO FORM -->
                <div id="form-info_contacto" class="tab-content hidden">
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Informaci贸n de Contacto</h3>
                        <p class="text-sm text-gray-600">Actualiza tu informaci贸n de contacto personal y empresarial.</p>
                    </div>
                    
                    <form onsubmit="submitForm(event, 'info_contacto')" class="space-y-4 sm:space-y-6">
                        <div class="grid grid-cols-1 gap-4 sm:gap-6">
                            <!-- Nombre Completo -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Nombre Completo
                                    <span class="text-xs text-gray-500">(2-150 caracteres)</span>
                                </label>
                                <input type="text" 
                                       name="nombre_completo" 
                                       id="contacto-nombre_completo" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       minlength="2" 
                                       maxlength="150"
                                       placeholder="Juan P茅rez Gonz谩lez">
                            </div>
                            
                            <!-- Nombre Empresa -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Empresa</label>
                                <input type="text" 
                                       name="nombre_empresa" 
                                       id="contacto-nombre_empresa" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       placeholder="Mi Empresa Ap铆cola">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 gap-4 sm:gap-6">
                            <!-- Correo Principal (Solo lectura) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Correo Principal</label>
                                <div class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-50 text-gray-700" id="contacto-correo_principal-display">
                                    <!-- Se llena autom谩ticamente desde los datos del usuario -->
                                </div>
                                <input type="hidden" name="correo_principal" id="contacto-correo_principal">
                                <p class="text-xs text-gray-500 mt-1">El correo no se puede modificar desde aqu铆</p>
                            </div>
                            
                            <!-- Tel茅fono Principal -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tel茅fono Principal</label>
                                <input type="tel" 
                                       name="telefono_principal" 
                                       id="contacto-telefono_principal" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       placeholder="+56 9 1234 5678">
                            </div>
                        </div>
                        
                        <!-- Direcci贸n -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Direcci贸n</label>
                            <input type="text" 
                                   name="direccion" 
                                   id="contacto-direccion" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                   placeholder="Av. Principal 123, Depto 4B">
                        </div>
                        
                        <div class="grid grid-cols-1 gap-4 sm:gap-6">
                            <!-- Regi贸n -->
                            <div>
                                <label for="contacto-region" class="block text-sm font-medium text-gray-700 mb-2">Regi贸n</label>
                                <select name="region" 
                                        id="contacto-region" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                                    <option value="">Cargando regiones...</option>
                                </select>
                            </div>
                            <!-- Comuna -->
                            <div>
                                <label for="contacto-comuna" class="block text-sm font-medium text-gray-700 mb-2">Comuna</label>
                                <select name="comuna" 
                                        id="contacto-comuna" 
                                        class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500">
                                    <option value="">Cargando comunas...</option>
                                </select>
                            </div>
                        </div>
                        
                        <button type="submit" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-medium py-2 sm:py-3 px-4 rounded-lg transition-colors text-sm sm:text-base">
                            <i class="fas fa-save mr-2"></i>Guardar y Continuar a Ubicaci贸n
                        </button>
                    </form>
                </div>

                <!-- UBICACIONES FORM -->
                <div id="form-ubicaciones" class="tab-content hidden">
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Ubicaci贸n</h3>
                        <p class="text-sm text-gray-600">Agrega una nueva ubicaci贸n. Se reemplazar谩 la ubicaci贸n anterior.</p>
                    </div>
                    
                    <!-- Instrucciones -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <div class="flex items-center justify-between">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900 mb-2">Mis Ubicaciones</h3>
                                <p class="text-sm text-gray-600">Gestiona tus ubicaciones de colmenares</p>
                            </div>
                            <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                                <button onclick="showAddLocationForm()" class="bg-amber-600 text-white px-4 py-2 rounded-md hover:bg-amber-700 text-sm sm:text-base">
                                    <i class="fas fa-plus mr-2"></i>Nueva Ubicaci贸n
                                </button>
                                <button onclick="showDeleteLocationForm()" class="bg-red-600 text-white px-4 py-2 rounded-md hover:bg-red-700 text-sm sm:text-base">
                                    <i class="fas fa-trash mr-2"></i>Eliminar Ubicaci贸n
                                </button>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Lista de ubicaciones existentes -->
                    <div id="ubicaciones-list" class="mb-6">
                        <div class="text-center py-8 text-gray-500">
                            <i class="fas fa-map-marker-alt text-4xl mb-2"></i>
                            <p>Cargando ubicaciones...</p>
                        </div>
                    </div>
                                       
                    <!-- Formulario para agregar/editar ubicaci贸n -->
                    <div id="ubicacion-form-container" class="hidden bg-gray-50 p-6 rounded-lg">
                        <div class="flex justify-between items-center mb-4">
                            <h4 id="ubicacion-form-title" class="text-md font-semibold">Agregar Nueva Ubicaci贸n</h4>
                            <button onclick="hideAddLocationForm()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <form id="ubicacion-form" class="space-y-4 sm:space-y-6">
                            <input type="hidden" name="id" id="ubicaciones-id">
                            
                            <!-- Plus Code -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Google Maps Plus Code *</label>
                                <input type="text" 
                                       name="gmaps_plus_code" 
                                       id="ubicaciones-gmaps_plus_code" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       placeholder="6RXC+Q7C Colluqueo, Lonquimay"
                                       required>
                                <p class="text-xs text-gray-500 mt-1">Ejemplo: 6RXC+Q7C Colluqueo, Lonquimay</p>
                            </div>
                            
                            <!-- Nombre de ubicaci贸n -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre de la ubicaci贸n *</label>
                                <input type="text" 
                                       name="nombre" 
                                       id="ubicaciones-nombre" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       placeholder="Colmenar Principal - Colluqueo, Lonquimay"
                                       required>
                            </div>
                            
                            <!-- Latitud (oculto) -->
                            <input type="hidden" name="latitud" id="ubicaciones-latitud">
                            
                            <!-- Longitud (oculto) -->
                            <input type="hidden" name="longitud" id="ubicaciones-longitud">
                            
                            <!-- Descripci贸n -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Descripci贸n</label>
                                <textarea name="descripcion" 
                                          id="ubicaciones-descripcion" 
                                          class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                          placeholder="Descripci贸n adicional de la ubicaci贸n"
                                          rows="3"></textarea>
                            </div>
                            
                            <div class="flex flex-col sm:flex-row gap-2 sm:gap-3">
                                <button type="submit" 
                                        onclick="submitUbicacionForm(event)" 
                                        class="flex-1 bg-amber-600 text-white py-2 px-4 rounded-md hover:bg-amber-700 focus:outline-none focus:ring-2 focus:ring-amber-500 focus:ring-offset-2 text-sm sm:text-base">
                                    <i class="fas fa-save mr-2"></i><span id="ubicacion-submit-text">Guardar Ubicaci贸n</span>
                                </button>
                                <button type="button" 
                                        onclick="hideAddLocationForm()" 
                                        class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 text-sm sm:text-base">
                                    Cancelar
                                </button>
                            </div>
                        </form>
                    </div>
                    
                    <!-- Formulario para eliminar ubicaci贸n -->
                    <div id="delete-location-form-container" class="hidden bg-red-50 p-6 rounded-lg border border-red-200">
                        <div class="flex justify-between items-center mb-4">
                            <h4 class="text-md font-semibold text-red-800">Eliminar Ubicaci贸n</h4>
                            <button onclick="hideDeleteLocationForm()" class="text-gray-500 hover:text-gray-700">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        
                        <div class="mb-4">
                            <p class="text-sm text-red-600 mb-4">Selecciona la ubicaci贸n que deseas eliminar. Esta acci贸n no se puede deshacer.</p>
                            <select id="delete-location-select" class="w-full px-3 py-2 border border-red-300 rounded-md focus:outline-none focus:ring-2 focus:ring-red-500">
                                <option value="">Selecciona una ubicaci贸n...</option>
                            </select>
                        </div>
                        
                        <div class="flex flex-col sm:flex-row justify-end gap-2 sm:gap-3">
                            <button type="button" 
                                    onclick="confirmDeleteLocation()" 
                                    class="px-4 py-2 bg-red-600 text-white rounded-md hover:bg-red-700 disabled:opacity-50 text-sm sm:text-base">
                                <i class="fas fa-trash mr-2"></i>Eliminar
                            </button>
                            <button type="button" 
                                    onclick="hideDeleteLocationForm()" 
                                    class="px-4 py-2 border border-gray-300 rounded-md text-gray-700 hover:bg-gray-50 text-sm sm:text-base">
                                Cancelar
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Messages -->
<div id="toast" class="fixed top-4 right-4 z-50 hidden">
    <div class="bg-white border border-gray-200 rounded-lg shadow-lg p-4 max-w-sm">
        <div class="flex items-center">
            <div id="toast-icon" class="mr-3"></div>
            <div>
                <p id="toast-message" class="text-sm font-medium text-gray-900"></p>
            </div>
        </div>
    </div>
</div>

<script>
// Request Password Reset for Authenticated User
function requestPasswordReset() {
    const btn = document.getElementById('request-reset-btn');
    const originalText = btn.innerHTML;
    btn.disabled = true;
    btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Enviando...';

    fetch('/api/auth/request-password-reset', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
            'Accept': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showToast('success', data.message || 'Correo de recuperaci贸n enviado.');
        } else {
            showToast('error', data.error || 'No se pudo enviar el correo.');
        }
    })
    .catch(error => {
        console.error('Error:', error);
        showToast('error', 'Ocurri贸 un error de red.');
    })
    .finally(() => {
        btn.disabled = false;
        btn.innerHTML = originalText;
    });
}

// Tab Management
function showTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Remove active styles from all tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('border-amber-500', 'text-amber-600');
        btn.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Show selected tab content
    document.getElementById(`form-${tabName}`).classList.remove('hidden');
    
    // Add active styles to selected tab
    const activeTab = document.getElementById(`tab-${tabName}`);
    activeTab.classList.remove('border-transparent', 'text-gray-500');
    activeTab.classList.add('border-amber-500', 'text-amber-600');
    
    // Populate data for the selected tab from global state, except for 'seguridad'
    if (tabName !== 'seguridad') {
        populateTabData(tabName);
    }
}

// Load existing data for a tab
async function loadAllData() {
    try {
        const response = await fetch('/api/data/usuarios');
        const result = await response.json();

        if (result.success) {
            window.userData = {
                usuario: result.usuario || {},
                info_contacto: result.info_contacto || {},
                ubicaciones: result.ubicaciones || [],
                id: result.id
            };
            window.currentUserId = result.id;
            console.log('Todos los datos del usuario cargados:', window.userData);
            
            // Populate the initial tab
            populateTabData('usuarios');
        } else {
            showToast('error', 'No se pudieron cargar los datos del perfil.');
        }
    } catch (error) {
        console.error('Error loading all user data:', error);
        showToast('error', 'Error de red al cargar datos.');
    }
}

function populateTabData(tabName) {
    if (!window.userData) {
        console.error('Los datos del usuario no est谩n cargados.');
        return;
    }

    if (tabName === 'usuarios') {
        const data = window.userData.usuario;
        document.getElementById('usuarios-username-display').textContent = data.username || '';
        document.getElementById('usuarios-tipo_usuario').value = data.tipo_usuario || '';
        document.getElementById('usuarios-role').value = data.role || 'regular';
    } else if (tabName === 'info_contacto') {
        const data = window.userData.info_contacto;
        document.getElementById('contacto-nombre_completo').value = data.nombre_completo || '';
        document.getElementById('contacto-nombre_empresa').value = data.nombre_empresa || '';
        
        const userEmail = data.correo_principal || 'No disponible';
        document.getElementById('contacto-correo_principal-display').textContent = userEmail;
        document.getElementById('contacto-correo_principal').value = data.correo_principal || '';
        
        document.getElementById('contacto-direccion').value = data.direccion || '';
        document.getElementById('contacto-comuna').value = data.comuna || '';
        document.getElementById('contacto-region').value = data.region || '';
        document.getElementById('contacto-telefono_principal').value = data.telefono_principal || '';
    } else if (tabName === 'ubicaciones') {
        const ubicaciones = window.userData.ubicaciones;
        displayUbicaciones(ubicaciones || []);
    }
}

// Form submission
async function submitForm(event, tableName) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const data = {};
    
    // Convertir FormData a objeto - SOLO incluir campos con contenido
    for (let [key, value] of formData.entries()) {
        const trimmedValue = value.trim();
        if (trimmedValue !== '') {
            data[key] = trimmedValue;
        }
    }
    
    // Si no hay ning煤n campo con contenido, mostrar advertencia
    if (Object.keys(data).length === 0) {
        showToast('warning', 'Por favor ingresa al menos un valor para guardar');
        return;
    }
    
    console.log('Enviando datos:', data);
    
    try {
        const response = await fetch(`/api/edit/${tableName}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('success', `${tableName.charAt(0).toUpperCase() + tableName.slice(1)} actualizado exitosamente`);
            
            // Navegar a la siguiente pesta帽a seg煤n el flujo
            setTimeout(() => {
                if (tableName === 'usuarios') {
                    showTab('info_contacto');
                } else if (tableName === 'info_contacto') {
                    showTab('ubicaciones');
                } else if (tableName === 'ubicaciones') {
                    // Redirigir al perfil despu茅s de completar ubicaciones
                    const userId = window.currentUserId;
                    if (userId && userId !== 'undefined' && userId !== 'null') {
                        const fullProfileUrl = `/profile/${userId}`;
                        console.log('Redirigiendo a perfil:', fullProfileUrl);
                        window.location.href = fullProfileUrl;
                    } else {
                        console.error('No se pudo obtener el UUID del usuario');
                        window.location.href = '/profile';
                    }
                }
            }, 1500);
        } else {
            showToast('error', result.error || 'Error al actualizar');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('error', 'Error al procesar la solicitud');
    }
}

document.addEventListener('DOMContentLoaded', function() {
    loadAllData(); // Cargar todos los datos del usuario al iniciar

    const regionSelect = document.getElementById('contacto-region');
    const comunaSelect = document.getElementById('contacto-comuna');

    async function populateDropdown(selectElement, apiUrl, dataKey, placeholder) {
        try {
            const response = await fetch(apiUrl);
            const result = await response.json();

            if (result.success) {
                selectElement.innerHTML = `<option value="">${placeholder}</option>`;
                result[dataKey].forEach(item => {
                    const option = document.createElement('option');
                    option.value = item;
                    option.textContent = item;
                    selectElement.appendChild(option);
                });
            } else {
                selectElement.innerHTML = `<option value="">Error al cargar</option>`;
                console.error(`Error al cargar ${dataKey}:`, result.error);
            }
        } catch (error) {
            selectElement.innerHTML = `<option value="">Error de red</option>`;
            console.error(`Error de red al cargar ${dataKey}:`, error);
        }
    }

    // Obtener la ubicaci贸n del usuario. Usar 'None' como string para diferenciar de un string vac铆o.
    const userRegion = "{{ user_location.region if user_location.region is not none else 'None' }}";
    const userComuna = "{{ user_location.comuna if user_location.comuna is not none else 'None' }}";

    // Comprobar si los valores son v谩lidos (no nulos y no vac铆os)
    const isRegionSet = userRegion && userRegion !== 'None';
    const isComunaSet = userComuna && userComuna !== 'None';

    if (isRegionSet && isComunaSet) {
        // Si ambos campos est谩n establecidos, mostrarlos y deshabilitarlos
        regionSelect.innerHTML = `<option value="${userRegion}">${userRegion}</option>`;
        comunaSelect.innerHTML = `<option value="${userComuna}">${userComuna}</option>`;
        regionSelect.disabled = true;
        comunaSelect.disabled = true;
    } else {
        // Si uno o ambos campos no est谩n establecidos, permitir la selecci贸n
        populateDropdown(regionSelect, '/api/regiones', 'regiones', 'Selecciona una regi贸n...');
        comunaSelect.disabled = true;
        comunaSelect.innerHTML = '<option value="">Selecciona una regi贸n primero</option>';
    }

    // Event listener para el cambio de regi贸n
    regionSelect.addEventListener('change', function() {
        const selectedRegion = this.value;
        comunaSelect.disabled = true;
        comunaSelect.innerHTML = '<option value="">Cargando comunas...</option>';

        if (selectedRegion) {
            // Cargar comunas basadas en la regi贸n seleccionada
            populateDropdown(comunaSelect, `/api/comunas?region=${encodeURIComponent(selectedRegion)}`, 'comunas', 'Selecciona una comuna...')
                .then(() => {
                    comunaSelect.disabled = false; // Habilitar el dropdown de comunas
                });
        } else {
            // Si no hay regi贸n seleccionada, deshabilitar y limpiar comunas
            comunaSelect.innerHTML = '<option value="">Selecciona una regi贸n primero</option>';
        }
    });
});

async function submitPasswordChange(event) {
    event.preventDefault();
    const currentPassword = document.getElementById('current-password').value;
    const newPassword = document.getElementById('new-password').value;
    const confirmNewPassword = document.getElementById('confirm-new-password').value;

    if (newPassword !== confirmNewPassword) {
        showToast('error', 'Las nuevas contrase帽as no coinciden.');
        return;
    }

    if (newPassword.length < 6) {
        showToast('error', 'La nueva contrase帽a debe tener al menos 6 caracteres.');
        return;
    }

    try {
        const response = await fetch('/api/auth/change-password', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ 
                current_password: currentPassword, 
                new_password: newPassword 
            })
        });

        const result = await response.json();

        if (result.success) {
            showToast('success', 'Contrase帽a actualizada exitosamente.');
            event.target.reset(); // Limpiar el formulario
        } else {
            showToast('error', result.error || 'No se pudo actualizar la contrase帽a.');
        }
    } catch (error) {
        showToast('error', 'Ocurri贸 un error en el servidor.');
    }
}

// Funciones para gesti贸n de ubicaciones
function showAddLocationForm() {
    document.getElementById('ubicacion-form-container').classList.remove('hidden');
    document.getElementById('ubicacion-form-title').textContent = 'Agregar Nueva Ubicaci贸n';
    document.getElementById('ubicacion-submit-text').textContent = 'Guardar Ubicaci贸n';
    document.getElementById('ubicacion-form').reset();
    document.getElementById('ubicaciones-id').value = '';
}

function hideAddLocationForm() {
    document.getElementById('ubicacion-form-container').classList.add('hidden');
    document.getElementById('ubicacion-form').reset();
}

function editUbicacion(ubicacion) {
    document.getElementById('ubicacion-form-container').classList.remove('hidden');
    document.getElementById('ubicacion-form-title').textContent = 'Editar Ubicaci贸n';
    document.getElementById('ubicacion-submit-text').textContent = 'Actualizar Ubicaci贸n';
    
    // Llenar el formulario con los datos existentes
    document.getElementById('ubicaciones-id').value = ubicacion.id || '';
    document.getElementById('ubicaciones-gmaps_plus_code').value = ubicacion.gmaps_plus_code || '';
    document.getElementById('ubicaciones-nombre').value = ubicacion.nombre || '';
    document.getElementById('ubicaciones-latitud').value = ubicacion.latitud || '';
    document.getElementById('ubicaciones-longitud').value = ubicacion.longitud || '';
    document.getElementById('ubicaciones-descripcion').value = ubicacion.descripcion || '';
}

function displayUbicaciones(ubicaciones) {
    const container = document.getElementById('ubicaciones-list');
    
    if (!Array.isArray(ubicaciones) || ubicaciones.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-map-marker-alt text-4xl mb-2"></i>
                <p>No tienes ubicaciones registradas</p>
                <button onclick="showAddLocationForm()" class="mt-4 text-amber-600 hover:text-amber-700">
                    <i class="fas fa-plus mr-1"></i>Agregar primera ubicaci贸n
                </button>
            </div>
        `;
        return;
    }
    
    container.innerHTML = ubicaciones.map(ubicacion => `
        <div class="bg-white border border-gray-200 rounded-lg p-4 mb-4">
            <div class="flex justify-between items-start">
                <div class="flex-1">
                    <h4 class="font-semibold text-gray-900">${ubicacion.nombre || 'Sin nombre'}</h4>
                    <p class="text-sm text-gray-600 mt-1">${ubicacion.descripcion || 'Sin descripci贸n'}</p>
                    <div class="mt-2">
                        <span class="text-xs bg-gray-100 text-gray-700 px-2 py-1 rounded">${ubicacion.gmaps_plus_code}</span>
                        <a href="https://maps.google.com/?q=${ubicacion.latitud},${ubicacion.longitud}" 
                           target="_blank" 
                           class="text-xs text-amber-600 hover:text-amber-700 ml-2">
                            <i class="fas fa-external-link-alt mr-1"></i>Ver en Maps
                        </a>
                    </div>
                </div>
                <div class="flex space-x-2 ml-4">
                    <button onclick='editUbicacion(${JSON.stringify(ubicacion).replace(/'/g, "&apos;")})' 
                            class="text-blue-600 hover:text-blue-800 p-1">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button onclick='deleteUbicacion("${ubicacion.id}")' 
                            class="text-red-600 hover:text-red-800 p-1">
                        <i class="fas fa-trash"></i>
                    </button>
                </div>
            </div>
        </div>
    `).join('');
}

async function deleteUbicacion(id) {
    if (!confirm('驴Est谩s seguro de eliminar esta ubicaci贸n?')) return;
    
    try {
        const response = await fetch('/api/edit/ubicaciones', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({ id })
        });
        
        const result = await response.json();
        if (result.success) {
            showToast('Ubicaci贸n eliminada exitosamente', 'success');
            loadTabData('ubicaciones');
        } else {
            showToast('Error: ' + result.error, 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error al eliminar ubicaci贸n', 'error');
    }
}

// Funci贸n actualizada para enviar formulario de ubicaciones
async function submitUbicacionForm(event) {
    event.preventDefault();
    
    const form = document.getElementById('ubicacion-form');
    const formData = new FormData(form);
    
    // Convertir FormData a objeto
    const data = {};
    formData.forEach((value, key) => {
        data[key] = value;
    });
    
    // Limpiar Plus Code (remover texto adicional)
    if (data.gmaps_plus_code) {
        // Extraer solo el Plus Code (ej: "6RXC+Q7C" de "6RXC+Q7C Colluqueo")
        const plusCodeMatch = data.gmaps_plus_code.match(/([23456789CFGHJMPQRVWX]{8,}[+]?[23456789CFGHJMPQRVWX]{2,})/i);
        if (plusCodeMatch) {
            data.gmaps_plus_code = plusCodeMatch[1].toUpperCase();
        }
    }
    
    console.log(' Enviando datos:', data);
    
    // Determinar m茅todo HTTP seg煤n si es edici贸n o creaci贸n
    const method = data.id ? 'PUT' : 'POST';
    
    // Enviar al backend
    fetch('/api/edit/ubicaciones', {
        method: method,
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify(data)
    })
    .then(response => response.json())
    .then(result => {
        console.log(' Respuesta:', result);
        if (result.success) {
            showToast('Ubicaci贸n guardada exitosamente', 'success');
            hideAddLocationForm();
            loadTabData('ubicaciones');
            form.reset();
        } else {
            showToast('Error: ' + result.error, 'error');
        }
    })
    .catch(error => {
        console.error(' Error:', error);
        showToast('Error al guardar ubicaci贸n', 'error');
    });
}

// Toast notifications
function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    const icon = document.getElementById('toast-icon');
    const messageEl = document.getElementById('toast-message');

    // Set icon and colors based on type
    if (type === 'success') {
        icon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
        toast.querySelector('div').classList.add('border-green-200');
    } else if (type === 'error') {
        icon.innerHTML = '<i class="fas fa-exclamation-circle text-red-500"></i>';
        toast.querySelector('div').classList.add('border-red-200');
    } else {
        icon.innerHTML = '<i class="fas fa-info-circle text-blue-500"></i>';
        toast.querySelector('div').classList.add('border-blue-200');
    }
    
    messageEl.textContent = message;
    toast.classList.remove('hidden');
    
    // Auto hide after 5 seconds
    setTimeout(() => {
        toast.classList.add('hidden');
        // Reset classes
        toast.querySelector('div').classList.remove('border-green-200', 'border-red-200', 'border-blue-200');
    }, 5000);
}

// Mostrar formulario de agregar ubicaci贸n
function showAddLocationForm() {
    document.getElementById('ubicacion-form-container').classList.remove('hidden');
    document.getElementById('delete-location-form-container').classList.add('hidden');
}

// Ocultar formulario de agregar ubicaci贸n
function hideAddLocationForm() {
    document.getElementById('ubicacion-form-container').classList.add('hidden');
}

// Mostrar formulario de eliminar ubicaci贸n
function showDeleteLocationForm() {
    document.getElementById('delete-location-form-container').classList.remove('hidden');
    document.getElementById('ubicacion-form-container').classList.add('hidden');
    loadLocationOptions();
}

// Ocultar formulario de eliminar ubicaci贸n
function hideDeleteLocationForm() {
    document.getElementById('delete-location-form-container').classList.add('hidden');
}

// Cargar opciones de ubicaciones para eliminar
async function loadLocationOptions() {
    try {
        const response = await fetch('/api/data/ubicaciones');
        const result = await response.json();
        
        const select = document.getElementById('delete-location-select');
        select.innerHTML = '<option value="">Selecciona una ubicaci贸n...</option>';
        
        if (result.success && result.ubicaciones && result.ubicaciones.length > 0) {
            result.ubicaciones.forEach(ubicacion => {
                const option = document.createElement('option');
                option.value = ubicacion.id;
                option.textContent = `${ubicacion.nombre} (${ubicacion.latitud}, ${ubicacion.longitud})`;
                select.appendChild(option);
            });
        } else {
            const option = document.createElement('option');
            option.value = '';
            option.textContent = 'No hay ubicaciones para eliminar';
            option.disabled = true;
            select.appendChild(option);
        }
    } catch (error) {
        console.error('Error cargando ubicaciones:', error);
        showToast('Error cargando ubicaciones', 'error');
    }
}

// Confirmar eliminaci贸n de ubicaci贸n
async function confirmDeleteLocation() {
    const select = document.getElementById('delete-location-select');
    const locationId = select.value;
    
    if (!locationId) {
        showToast('Por favor selecciona una ubicaci贸n', 'error');
        return;
    }
    
    if (!confirm('驴Est谩s seguro de que deseas eliminar esta ubicaci贸n? Esta acci贸n no se puede deshacer.')) {
        return;
    }
    
    try {
        const response = await fetch('/api/edit/ubicaciones', {
            method: 'DELETE',
            headers: {
                'Content-Type': 'application/json'
            },
            body: JSON.stringify({ id: locationId })
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast('Ubicaci贸n eliminada correctamente', 'success');
            hideDeleteLocationForm();
            // Recargar la lista de ubicaciones
            loadTabData('ubicaciones');
        } else {
            showToast(result.error || 'Error eliminando ubicaci贸n', 'error');
        }
    } catch (error) {
        console.error('Error eliminando ubicaci贸n:', error);
        showToast('Error eliminando ubicaci贸n', 'error');
    }
}

// Mostrar ubicaciones en la lista
function displayUbicaciones(ubicaciones) {
    const container = document.getElementById('ubicaciones-list');
    
    if (!ubicaciones || ubicaciones.length === 0) {
        container.innerHTML = `
            <div class="text-center py-8 text-gray-500">
                <i class="fas fa-map-marker-alt text-4xl mb-2"></i>
                <p>No hay ubicaciones registradas</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = ubicaciones.map(ubicacion => `
        <div class="bg-white border border-gray-200 rounded-lg p-4 mb-3">
            <div class="flex justify-between items-start">
                <div>
                    <h4 class="font-semibold text-gray-900">${ubicacion.nombre}</h4>
                    <p class="text-sm text-gray-600">Lat: ${ubicacion.latitud}, Lng: ${ubicacion.longitud}</p>
                    ${ubicacion.descripcion ? `<p class="text-sm text-gray-500 mt-1">${ubicacion.descripcion}</p>` : ''}
                </div>
                <div class="text-xs text-gray-400">
                    ${ubicacion.norma_geo || 'WGS84'}
                </div>
            </div>
        </div>
    `).join('');
}

// Navigate to profile using already loaded user ID
function goToProfile() {
    if (window.currentUserId) {
        window.location.href = `/profile/${window.currentUserId}`;
    } else {
        window.location.href = '/profile';
    }
}

// Initialize page
document.addEventListener('DOMContentLoaded', function() {
    showTab('usuarios'); // Show first tab by default
    
    // Precargar datos de todas las pesta帽as
    setTimeout(() => {
        loadTabData('info_contacto');
        loadTabData('ubicaciones');
    }, 500);
});
</script>
{% endblock %}
