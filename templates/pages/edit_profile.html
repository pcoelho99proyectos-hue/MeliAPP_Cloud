{% extends "base/layout.html" %}

{% block title %}Editar Perfil - MeliAPP{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-amber-50 to-orange-100 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="bg-white rounded-xl shadow-lg mb-6">
            <div class="px-6 py-4 border-b border-gray-200">
                <div class="flex items-center justify-between">
                    <div>
                        <h1 class="text-2xl font-bold text-gray-900">üçØ Editar Informaci√≥n Personal</h1>
                        <p class="text-sm text-gray-600 mt-1">Actualiza tus datos personales de forma segura</p>
                    </div>
                    <a href="/profile" class="inline-flex items-center px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-700 rounded-lg transition-colors">
                        <i class="fas fa-arrow-left mr-2"></i>Volver al Perfil
                    </a>
                </div>
            </div>
        </div>

        <!-- Tab Navigation -->
        <div class="bg-white rounded-xl shadow-lg mb-6">
            <div class="px-6 py-4">
                <nav class="flex space-x-8 border-b border-gray-200">
                    <button onclick="showTab('usuarios')" id="tab-usuarios" class="tab-btn py-3 px-1 border-b-2 border-amber-500 text-amber-600 font-medium">
                        <i class="fas fa-user mr-2"></i>Usuario
                    </button>
                    <button onclick="showTab('info_contacto')" id="tab-info_contacto" class="tab-btn py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        <i class="fas fa-address-card mr-2"></i>Contacto
                    </button>
                    <button onclick="showTab('ubicaciones')" id="tab-ubicaciones" class="tab-btn py-3 px-1 border-b-2 border-transparent text-gray-500 hover:text-gray-700">
                        <i class="fas fa-map-marker-alt mr-2"></i>Ubicaci√≥n
                    </button>
                </nav>
            </div>
        </div>

        <!-- Forms Container -->
        <div class="bg-white rounded-xl shadow-lg">
            <div class="px-6 py-8">
                
                <!-- USUARIOS FORM -->
                <div id="form-usuarios" class="tab-content">
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Datos de Usuario</h3>
                        <p class="text-sm text-gray-600">Edita tu username y rol. El tipo de usuario siempre es "Regular".</p>
                    </div>
                    
                    <form onsubmit="submitForm(event, 'usuarios')" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Username -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Username *
                                    <span class="text-xs text-gray-500">(3-80 caracteres, solo letras, n√∫meros, - y _)</span>
                                </label>
                                <input type="text" 
                                       name="username" 
                                       id="usuarios-username" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       minlength="3" 
                                       maxlength="80" 
                                       pattern="^[a-zA-Z0-9_-]+$"
                                       required>
                            </div>
                            
                            <!-- Tipo Usuario (readonly) -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tipo de Usuario</label>
                                <input type="text" 
                                       value="Regular" 
                                       readonly 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md bg-gray-100 text-gray-600 cursor-not-allowed">
                                <p class="text-xs text-gray-500 mt-1">Siempre "Regular" para usuarios registrados</p>
                            </div>
                        </div>
                        
                        <!-- Role -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Rol *</label>
                            <select name="role" 
                                    id="usuarios-role" 
                                    class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                    required>
                                <option value="APICULTOR">APICULTOR</option>
                                <option value="PROVEEDOR">PROVEEDOR</option>
                                <option value="PRESTADOR DE SERVICIOS">PRESTADOR DE SERVICIOS</option>
                            </select>
                        </div>
                        
                        <button type="submit" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                            <i class="fas fa-save mr-2"></i>Guardar Datos de Usuario
                        </button>
                    </form>
                </div>

                <!-- INFO_CONTACTO FORM -->
                <div id="form-info_contacto" class="tab-content hidden">
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Informaci√≥n de Contacto</h3>
                        <p class="text-sm text-gray-600">Actualiza tu informaci√≥n de contacto personal y empresarial.</p>
                    </div>
                    
                    <form onsubmit="submitForm(event, 'info_contacto')" class="space-y-6">
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Nombre Completo -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">
                                    Nombre Completo
                                    <span class="text-xs text-gray-500">(2-150 caracteres)</span>
                                </label>
                                <input type="text" 
                                       name="nombre_completo" 
                                       id="contacto-nombre_completo" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       minlength="2" 
                                       maxlength="150"
                                       placeholder="Juan P√©rez Gonz√°lez">
                            </div>
                            
                            <!-- Nombre Empresa -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Nombre Empresa</label>
                                <input type="text" 
                                       name="nombre_empresa" 
                                       id="contacto-nombre_empresa" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       placeholder="Mi Empresa Ap√≠cola">
                            </div>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Correo Principal -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Correo Principal</label>
                                <input type="email" 
                                       name="correo_principal" 
                                       id="contacto-correo_principal" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       placeholder="tu@email.com">
                            </div>
                            
                            <!-- Tel√©fono Principal -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Tel√©fono Principal</label>
                                <input type="tel" 
                                       name="telefono_principal" 
                                       id="contacto-telefono_principal" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       placeholder="+56 9 1234 5678">
                            </div>
                        </div>
                        
                        <!-- Direcci√≥n -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Direcci√≥n</label>
                            <input type="text" 
                                   name="direccion" 
                                   id="contacto-direccion" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                   placeholder="Av. Principal 123, Depto 4B">
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                            <!-- Comuna -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Comuna</label>
                                <input type="text" 
                                       name="comuna" 
                                       id="contacto-comuna" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       placeholder="Las Condes">
                            </div>
                            
                            <!-- Regi√≥n -->
                            <div>
                                <label class="block text-sm font-medium text-gray-700 mb-2">Regi√≥n</label>
                                <input type="text" 
                                       name="region" 
                                       id="contacto-region" 
                                       class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                       placeholder="Regi√≥n Metropolitana">
                            </div>
                        </div>
                        
                        <button type="submit" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                            <i class="fas fa-save mr-2"></i>Guardar Informaci√≥n de Contacto
                        </button>
                    </form>
                </div>

                <!-- UBICACIONES FORM -->
                <div id="form-ubicaciones" class="tab-content hidden">
                    <div class="mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-2">Ubicaci√≥n</h3>
                        <p class="text-sm text-gray-600">Agrega una nueva ubicaci√≥n. Se reemplazar√° la ubicaci√≥n anterior.</p>
                    </div>
                    
                    <!-- Instrucciones -->
                    <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6">
                        <div class="flex items-start">
                            <i class="fas fa-info-circle text-blue-500 mt-1 mr-3"></i>
                            <div>
                                <h4 class="font-medium text-blue-900 mb-2">Formato Requerido:</h4>
                                <p class="text-sm text-blue-800">
                                    <strong>SOLO PLUS CODE de Google Maps:</strong> CVV6+HJ7 Pichipehuenco, Lonquimay
                                </p>
                                <p class="text-xs text-blue-700 mt-2">
                                    Obt√©n el PLUS CODE desde Google Maps ‚Üí Compartir ‚Üí Copiar c√≥digo plus
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <form onsubmit="submitForm(event, 'ubicaciones')" class="space-y-6">
                        <!-- Ubicaci√≥n -->
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">Nueva Ubicaci√≥n *</label>
                            <input type="text" 
                                   name="ubicacion" 
                                   id="ubicaciones-ubicacion" 
                                   class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-amber-500 focus:border-amber-500"
                                   placeholder="CVV6+HJ7 Pichipehuenco, Lonquimay"
                                   required>
                            <p class="text-xs text-gray-500 mt-1">Solo PLUS CODE de Google Maps</p>
                        </div>
                        
                        <button type="submit" class="w-full bg-amber-500 hover:bg-amber-600 text-white font-medium py-3 px-4 rounded-lg transition-colors">
                            <i class="fas fa-map-marker-alt mr-2"></i>Actualizar Ubicaci√≥n
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Messages -->
<div id="toast" class="fixed top-4 right-4 z-50 hidden">
    <div class="bg-white border border-gray-200 rounded-lg shadow-lg p-4 max-w-sm">
        <div class="flex items-center">
            <div id="toast-icon" class="mr-3"></div>
            <div>
                <p id="toast-message" class="text-sm font-medium text-gray-900"></p>
            </div>
        </div>
    </div>
</div>

<script>
// Tab Management
function showTab(tabName) {
    // Hide all tab contents
    document.querySelectorAll('.tab-content').forEach(content => {
        content.classList.add('hidden');
    });
    
    // Remove active styles from all tabs
    document.querySelectorAll('.tab-btn').forEach(btn => {
        btn.classList.remove('border-amber-500', 'text-amber-600');
        btn.classList.add('border-transparent', 'text-gray-500');
    });
    
    // Show selected tab content
    document.getElementById(`form-${tabName}`).classList.remove('hidden');
    
    // Add active styles to selected tab
    const activeTab = document.getElementById(`tab-${tabName}`);
    activeTab.classList.remove('border-transparent', 'text-gray-500');
    activeTab.classList.add('border-amber-500', 'text-amber-600');
    
    // Load data for the selected tab
    loadTabData(tabName);
}

// Load existing data for a tab
async function loadTabData(tabName) {
    try {
        const response = await fetch(`/api/data/${tabName}`);
        const result = await response.json();
        
        if (result.success && result.data) {
            const data = result.data;
            
            // Populate form fields based on tab
            if (tabName === 'usuarios') {
                if (data.username) document.getElementById('usuarios-username').value = data.username;
                if (data.role) document.getElementById('usuarios-role').value = data.role;
            } else if (tabName === 'info_contacto') {
                if (data.nombre_completo) document.getElementById('contacto-nombre_completo').value = data.nombre_completo;
                if (data.nombre_empresa) document.getElementById('contacto-nombre_empresa').value = data.nombre_empresa;
                if (data.correo_principal) document.getElementById('contacto-correo_principal').value = data.correo_principal;
                if (data.telefono_principal) document.getElementById('contacto-telefono_principal').value = data.telefono_principal;
                if (data.direccion) document.getElementById('contacto-direccion').value = data.direccion;
                if (data.comuna) document.getElementById('contacto-comuna').value = data.comuna;
                if (data.region) document.getElementById('contacto-region').value = data.region;
            } else if (tabName === 'ubicaciones') {
                // For ubicaciones, show current location if exists
                if (Array.isArray(data) && data.length > 0) {
                    const ubicacion = data[0];
                    if (ubicacion.nombre) {
                        document.getElementById('ubicaciones-ubicacion').placeholder = `Actual: ${ubicacion.nombre}`;
                    }
                }
            }
        }
    } catch (error) {
        console.error('Error loading data:', error);
    }
}

// Form submission
async function submitForm(event, tableName) {
    event.preventDefault();
    
    const form = event.target;
    const formData = new FormData(form);
    const data = Object.fromEntries(formData.entries());
    
    // Remove empty values
    Object.keys(data).forEach(key => {
        if (data[key] === '') {
            delete data[key];
        }
    });
    
    try {
        showToast('Guardando...', 'info');
        
        const response = await fetch(`/api/edit/${tableName}`, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(data)
        });
        
        const result = await response.json();
        
        if (result.success) {
            showToast(result.message || 'Datos guardados correctamente', 'success');
            setTimeout(() => {
                // Redirigir al perfil del usuario actual
                window.location.href = '/profile/{{ session.get("user_uuid", "") }}';
            }, 2000);
        } else {
            showToast(result.error || 'Error al guardar datos', 'error');
        }
    } catch (error) {
        console.error('Error:', error);
        showToast('Error al conectar con el servidor', 'error');
    }
}

// Toast notifications
function showToast(message, type = 'info') {
    const toast = document.getElementById('toast');
    const icon = document.getElementById('toast-icon');
    const messageEl = document.getElementById('toast-message');
    
    // Set icon and colors based on type
    if (type === 'success') {
        icon.innerHTML = '<i class="fas fa-check-circle text-green-500"></i>';
        toast.querySelector('div').classList.add('border-green-200');
    } else if (type === 'error') {
        icon.innerHTML = '<i class="fas fa-exclamation-circle text-red-500"></i>';
        toast.querySelector('div').classList.add('border-red-200');
    } else {
        icon.innerHTML = '<i class="fas fa-info-circle text-blue-500"></i>';
        toast.querySelector('div').classList.add('border-blue-200');
    }
    
    messageEl.textContent = message;
    toast.classList.remove('hidden');
    
    // Auto hide after 5 seconds
    setTimeout(() => {
        toast.classList.add('hidden');
        // Reset classes
        toast.querySelector('div').classList.remove('border-green-200', 'border-red-200', 'border-blue-200');
    }, 5000);
}

// Initialize on page load
document.addEventListener('DOMContentLoaded', function() {
    // Show first tab by default
    showTab('usuarios');
});
</script>
{% endblock %}
